<?xml version="1.0" encoding="UTF-8"?>
<!-- Description                                                            -->
<!-- ===========                                                            -->
<!-- This page allows the user to edit the correspondence document.         -->
<PAGE
  PAGE_ID="BDMParticipant_resolveEditCommunicationExternal"
  POPUP_PAGE="true"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:noNamespaceSchemaLocation="file://Curam/UIMSchema.xsd"
>
  <PAGE_PARAMETER NAME="workItemID"/>
  <JSP_SCRIPTLET>
	
	<!-- Addressed bug 90655, handled logic for correspondence and record communication -->
    curam.omega3.request.RequestHandler 
      rh = curam.omega3.request.RequestHandlerFactory.getRequestHandler(request);
	
    String context = request.getContextPath() + "/";
    context += curam.omega3.user.UserPreferencesFactory.getUserPreferences(pageContext.getSession()).getLocale() + "/";
    String communicationID = request.getParameter("communicationID");
    String pageDescription = request.getParameter("pageDescription");
    String status = request.getParameter("status");
    String communicationFormat = request.getParameter("communicationFormat");
    String correspondentConcernRoleID = request.getParameter("correspondentConcernRoleID");      
    String concernRoleID = request.getParameter("concernRoleID");
    String url = "";
    String workItemID = request.getParameter("workItemID");

  	if (workItemID == null) {
	  core.ScriptletMissingParamException e = new
	    core.ScriptletMissingParamException(-20002, "workItemID");
	  throw e;
  	}
  	
  	if (communicationID == null) {
     core.ScriptletMissingParamException e = new
              core.ScriptletMissingParamException(-20002, "communicationID");
     throw e;
    }
                  
    if (pageDescription == null) {
     core.ScriptletMissingParamException e = new
              core.ScriptletMissingParamException(-20002, "pageDescription");
     throw e;
    }

    if (status == null) {
     core.ScriptletMissingParamException e = new
              core.ScriptletMissingParamException(-20002, "status");
     throw e;
    }
      
    if (communicationFormat == null) {
     core.ScriptletMissingParamException e = new
              core.ScriptletMissingParamException(-20002, "communicationFormat");
     throw e;
    }      
      
    if (correspondentConcernRoleID == null) {
     core.ScriptletMissingParamException e = new
              core.ScriptletMissingParamException(-20002, "correspondentConcernRoleID");
     throw e;
    }       
  	
	// Check for correspondence
  	if (communicationFormat.equals("BDMCF5")) {
  	
  	  String initialURL = curam.util.configuration.internal.CuramConfigurationManager.getConfiguration().getString("curam.ca.gc.bdm.cct.editorportal.edit.url");
	  String communityID = curam.util.configuration.internal.CuramConfigurationManager.getConfiguration().getString("curam.ca.gc.bdm.cct.community.value");
	  String finalURL = initialURL + "workitemid=" + workItemID + "&amp;community=" + communityID + "&amp;redirectToPrint=true";
	
	  if (screenContext != null &amp;&amp; screenContext.hasContextBits(
	              curam.omega3.taglib.ScreenContext.MODAL)) {
	    StringBuffer cont = new StringBuffer();
		cont.append("&lt;html&gt;").append("&lt;head&gt;");
		cont.append("&lt;title&gt;Close and Redirect&lt;/title&gt;");
		cont.append("&lt;script type=\"text/javascript\" src=\"../CDEJ/jscript/dojotk/dojo/dojo.js\"&gt;// script content&lt;/script&gt;");
		cont.append("&lt;script type=\"text/javascript\" src=\"../CDEJ/jscript/dojotk/dijit/dijit.js\"&gt;// script content&lt;/script&gt;");
		cont.append("&lt;script type=\"text/javascript\"&gt;");
		cont.append("dojo.registerModulePath('curam', '../../curam');");
		cont.append("dojo.registerModulePath('cm', '../../cm');");
		cont.append("&lt;/script&gt;");
		cont.append("&lt;script type=\"text/javascript\" src=\"../CDEJ/jscript/cdej-cm.js\"&gt;// script content&lt;/script&gt;");
		cont.append("&lt;script type=\"text/javascript\" src=\"../CDEJ/jscript/cdej.js\"&gt;// script content&lt;/script&gt;");
		cont.append("&lt;script type=\"text/javascript\"&gt;");
		cont.append("dojo.require('curam.util.Dialog');");
		cont.append("curam.util.Dialog.registerGetTitleFunc(function() {");
		cont.append("return 'Closing dialog'; });");
		cont.append("curam.util.Dialog.init();");
		cont.append("&lt;/script&gt;");
		out.write(cont.toString());
		out.write("&lt;/head&gt;");
		out.write("&lt;body&gt;");
		 
		StringBuffer cont2 = new StringBuffer();
		cont2.append("&lt;script type=\"text/javascript\"&gt;");
		cont2.append("dojo.addOnLoad(function() {");
		cont2.append("curam.util.Dialog.pageLoadFinished();");
		cont2.append("curam.util.Dialog.close(false);");
		cont2.append("});");
		cont2.append("window.open('" + finalURL + "','popUpWindow','height=1000,width=1000,resizable=yes,");
		cont2.append("scrollbars=yes,toolbar=yes,menubar=no,location=no,directories=no, status=yes');");
		cont2.append("&lt;/script&gt;");
		out.write(cont2.toString());
		out.write("&lt;/body&gt;");
		out.write("&lt;/html&gt;");
      }
    // Else Recorded
	} else {
        url = context + "Participant_modifyRecordedCommunicationFromList1Page.do" + "?communicationID=" 
        + curam.omega3.request.RequestUtils.escapeURL(communicationID) + "&amp;concernRoleID="                   
        + curam.omega3.request.RequestUtils.escapeURL(concernRoleID) + "&amp;correspondentConcernRoleID="                                            
        + curam.omega3.request.RequestUtils.escapeURL(correspondentConcernRoleID)
        + "&amp;pageDescription=" + curam.omega3.request.RequestUtils.escapeURL(pageDescription);
        url += "&amp;" + rh.getSystemParameters();  
        response.sendRedirect(response.encodeRedirectURL(url));
	}
  </JSP_SCRIPTLET>
</PAGE>