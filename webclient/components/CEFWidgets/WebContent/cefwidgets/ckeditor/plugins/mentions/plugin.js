/**
 * @license Copyright (c) 2003-2016, CKSource - Frederico Knabben. All rights reserved.
 * For licensing, see LICENSE.md or http://ckeditor.com/license
 */
"use strict";!function(){function t(){function t(t,n,i,r){this.pending=!1,this.inserted=!1,this.wrapper=null,e.call(this,t,n,i,"vcard"),r&&(this.view.itemTemplate=new CKEDITOR.template(r))}var e=CKEDITOR.plugins.autocomplete;t.wrapperDataId="mentions-wrapper",t.prototype=CKEDITOR.tools.prototypedCopy(e.prototype),t.prototype.commit=function(t){this.unwrapMatchedText(),e.prototype.commit.call(this,t)},t.prototype.onTextMatched=function(t){this.wrapMatchedText(t.data.text,t.data.range),this.pending||(this.pending=!0,this.inserted=!1,this.editor.fire("mentionStart")),e.prototype.onTextMatched.call(this,t)},t.prototype.onTextUnmatched=function(t){this.wrapper=null,e.prototype.onTextUnmatched.call(this,t),this.pending&&(this.inserted||this.editor.fire("mentionCancel"),this.pending=!1,this.inserted=!1)},t.prototype.insertWidget=function(t){this.inserted=!0;var n=e.prototype.insertWidget.call(this,t);return this.editor.fire("mentionComplete",n),n},t.prototype.wrapMatchedText=function(e,n){if(e&&n&&!this.getTextWrapper(n)){var i=new CKEDITOR.dom.element("span");i.setAttribute("data-cke-id",t.wrapperDataId),i.setText(e),n.deleteContents(),n.insertNode(i);var r=n.clone();r.selectNodeContents(i),r.collapse(),this.editor.getSelection().selectRanges([r])}},t.prototype.unwrapMatchedText=function(){var t=this.getTextWrapper(this.editor.getSelection().getRanges()[0]);t&&(t.remove(!0),this.wrapper=null)},t.prototype.getTextWrapper=function(e){if(!this.wrapper&&e){var n=e.startContainer.getParent(),i=e.endContainer.getParent();n&&"span"==n.getName()&&n.equals(i)&&n.getAttribute("data-cke-id")==t.wrapperDataId&&(this.wrapper=n)}return this.wrapper},CKEDITOR.plugins.mentions=t}function e(t,e,n,i,r){function a(t,e,n){var a=t.slice(0,e),o=t.slice(e),u=s(n),d=u?a.match(l):a.match(c),h=u?p(d,n):e;if(!d)return null;if(!u&&i){var m=a.substr(0,d.index);if(m&&!m.match(/\s+$/))return null}return!u&&r&&o&&!o.match(/^\s/)?null:{start:d.index,end:h,position:e}}function o(e){var i=t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),r=n?"\\w\\s":"\\w",a=i+"["+r+"]";return a+=e?"{"+e+",}":"*",a+="$",new RegExp(a)}function s(t){var e=t.startContainer.getParent(),n=t.endContainer.getParent();return"span"==e.getName()&&e.equals(n)&&e.getAttribute("data-cke-id")==CKEDITOR.plugins.mentions.wrapperDataId}function p(t,e){return t.index+e.startContainer.getParent().getText().length}var c=o(e),l=o(!1);return function(t){return t.collapsed?CKEDITOR.plugins.textMatch.match(t,function(e,n){return a(e,n,t)}):null}}function n(t,e){return""===t.mentions_prefix?t.mentions_prefix:t.mentions_prefix||e}function i(t){return t.mentions_dataCallback&&r(t.mentions_dataCallback)?t.mentions_dataCallback:null}function r(t){return!!(t&&t.call&&t.apply)}CKEDITOR.plugins.add("mentions",{requires:"autocomplete,textmatch,vcard",init:function(t){t.on("instanceReady",function(){var r=n(t.config,"@"),a=t.config.mentions_minChars||2,o=t.config.mentions_allowSpaces!==!1,s=t.config.mentions_itemTemplate,p=i(t.config);p&&(t.mentions=new CKEDITOR.plugins.mentions(t,e(r,a,o,!0,!0),p,s),t.on("change",function(){t.widgets.checkWidgets()}))})},onLoad:function(){t()}})}();