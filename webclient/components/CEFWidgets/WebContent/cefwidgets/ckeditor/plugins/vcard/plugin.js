/**
 * @license Copyright (c) 2003-2016, CKSource - Frederico Knabben. All rights reserved.
 * For licensing, see LICENSE.md or http://ckeditor.com/license
 */
"use strict";!function(){var t="cke_vcard",e="data-cke-inner-id";CKEDITOR.plugins.add("vcard",{requires:"widget",init:function(n){function i(){return(new Date).getTime()}function a(t){return u[t]===!0}function r(i){for(var a=0,r=n.editable().find("."+t),o=0;o<r.count();o++)r.getItem(o).getAttribute(e)==i&&a++;return a}function o(t,e){var n=0,i={},a=CKEDITOR.tools.objectKeys(t);for(n;n<a.length;n++)"classes"!=a[n]&&-1!==e.indexOf("{"+a[n]+"}")&&(i[a[n]]=t[a[n]]);return encodeURIComponent(JSON.stringify(i))}function s(t){return JSON.parse(decodeURIComponent(t))}var u={},d={},c=n.config.mentions_mentionTemplate||"{name}",l=c?new CKEDITOR.template(c):null;n.on("beforeSetMode",function(){u={},d={}}),n.on("change",function(){for(var i,r=n.editable().find("."+t),o=CKEDITOR.tools.objectKeys(u),s={},c=0;c<r.count();c++)i=r.getItem(c).getAttribute(e),i&&(s[i]=!0);for(var l=0;l<o.length;l++)i=o[l],!s[i]&&a(i)&&(u[i]=!1,n.fire("mentionRemove",d[i]),d[i]=null)}),n.widgets.add("vcard",{template:'<span class="'+t+'"></span>',draggable:!!n.config.mentions_draggable,data:function(){(!this.element.getAttribute(e)||r(this.element.getAttribute(e))>1)&&this.element.setAttribute(e,i());var n=this.element.getAttribute(e);u[n]=!0,d[n]=this,this.element.addClass(t),this.element.setHtml(l.output(this.data))},downcast:function(t){return t.attributes["data-vcard-item"]=o(this.data,c),t},upcast:function(t,e){return"span"==t.name&&t.attributes["data-vcard-item"]?(CKEDITOR.tools.extend(e,s(t.attributes["data-vcard-item"])),!0):!1}})}})}();