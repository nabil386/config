/* Copyright IBM Corp. 2009-2016  All Rights Reserved. *//* Copyright IBM Corp. 2010-2014 All Rights Reserved.                    */
!function(){CKEDITOR.plugins.add("ibmmarkdown",{lang:"ar,ca,cs,da,de,el,en,es,fi,fr,he,hr,hu,it,iw,ja,kk,ko,nb,nl,no,pl,pt,pt-br,ro,ru,sk,sl,sv,th,tr,uk,zh,zh-cn,zh-tw",icons:"bookmark",init:function(e){function t(e){CKEDITOR.env.webkit&&(e=e.replace(/\u200B/g,"")),CKEDITOR.env.ie&&(e=e.replace(/\u00A0/g,""));var t=marked.lexer(e);return t&&"undefined"!=typeof t[0].type&&"html"!=t[0].type&&("paragraph"!=t[0].type||marked(e).replace("<p>","").replace("</p>","")!=e)}function n(t){var n=new CKEDITOR.dom.range(e.document);n.moveToElementEditablePosition(t),n.select()}function a(e){var t=e.editable(),n=0;if(t){var a=t.getCustomData("cke-fillingChar");if(a){var i=e.document.$.defaultView.getSelection();"Caret"==i.type&&i.anchorNode==a.$&&(n=1);var s=a.getText();a.setText(r(s)),n&&(e.document.$.defaultView.getSelection().setPosition(a.$,a.getLength()),n=0)}}}function r(e){return e.replace(/\u200B( )?/g,function(e){return e[1]?" ":""})}e.addFeature(e.getCommand("ibmmarkdown"));var i=this.path;e.on("instanceReady",function(){"undefined"==typeof marked&&CKEDITOR.scriptLoader.load(i+"js/marked.js",function(){marked.setOptions({renderer:new marked.Renderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!1})})}),e.on("key",function(t){if(e.config.ibmAutoConvertMarkdown){var n=t.data.keyCode;13==n&&"source".valueOf()!=new String(e.mode).valueOf()&&(CKEDITOR.env.webkit||e.fire("saveSnapshot"),s(t))}});var s=function(r){var s,d,o=e.getSelection().getRanges()[0],g=o.endContainer;if(g.type==CKEDITOR.NODE_ELEMENT){var f=g.getChild(o.endOffset-1);f&&f.type==CKEDITOR.NODE_TEXT&&(d=f.getText())}else d=g.getText().substring(0,o.endOffset);if(d&&/\S/.test(d)){if(s=t(d),!s){var T;g.type==CKEDITOR.NODE_TEXT&&(T=g.getText().substring(o.endOffset));var l,u=g=g.type==CKEDITOR.NODE_ELEMENT&&g.getChildCount()>0?g.getChild(o.endOffset-1):g;if(u.getName&&"a"!=u.getName()||u.type==CKEDITOR.NODE_TEXT&&" "!=g.getText().charAt(0)){for(var c=!1,v=0;u&&u.getPrevious()&&u.getPrevious().type==CKEDITOR.NODE_TEXT;){if(v++,c||(u=u.getPrevious(),c=!0),d=u.getText()+d,l=d,u.getPrevious&&null!==u.getPrevious())var E=u.getPrevious();if(u=E?E:null,l.indexOf(" ")>=0||CKEDITOR.env.webkit&&/\s/g.test(l))break}var O=!1;if(u&&l&&u.type==CKEDITOR.NODE_TEXT&&u.getText()!=l){var p=u.getText(),C=p.charAt(p.length-1);if(" "!=C){O=!0;var m=p.lastIndexOf(" ");l=-1!=m?u.getText().substring(m+1)+l:u.getText()+l}}if(l&&(d=l),spaceIndex=d.lastIndexOf(" "),-1!=spaceIndex?mdText=d.substring(spaceIndex+1):mdText=d,s=t(mdText)){for(var u=g=g.type==CKEDITOR.NODE_ELEMENT&&g.getChildCount()>0?g.getChild(o.endOffset-1):g,x=0,c=!1,D=0;v>D;D++){x++,c||(u=u.getPrevious(),c=!0);var E=u.getPrevious();u.remove(),u=E}if(O){var m=u.getText().lastIndexOf(" ");-1!=m?u.setText(u.getText().substring(0,m+1)):u.setText("")}if(g.setText(d),T&&d!=T){var I=new CKEDITOR.dom.text(T);I.insertAfter(g)}}}}if(s){var m=d.lastIndexOf(" "),k=d.replace(/^\s+|\s+$/g,"");CKEDITOR.env.webkit&&(d=d.replace(/\u200B/g,""));var R=-1;CKEDITOR.env.ie&&(R=d.lastIndexOf(" "));var h=d.lastIndexOf(k);(-1!=m||0==h||CKEDITOR.env.ie&&-1!=R)&&g.type!=CKEDITOR.NODE_TEXT&&g.getChildCount()>0&&(g=g.getChild(o.endOffset-1));g.getParent();CKEDITOR.env.webkit&&(g.setText(g.getText().replace(/\u200B/g,"")),a(e)),r.cancel();r.data.keyCode,g.getText().substring(h+k.length);e.execCommand("enter");var K=e.getSelection().getRanges()[0].endContainer;e.fire("saveSnapshot");var b=e.createRange();b.setStart(g,h),b.setEnd(g,h+k.length),b.select();var y=e.getSelection().getSelectedText(),w=function(){e.insertHtml(marked(y).replace("<p>","").replace("</p>",""));var t=new CKEDITOR.dom.element.createFromHtml("&#8203");CKEDITOR.env.webkit&&!/\S/.test(K.getText())&&t.insertAfter(K),n(K)};"undefined"==typeof marked?CKEDITOR.scriptLoader.load(i+"js/marked.js",w):w()}}}}})}();