/**
 * @license Copyright (c) 2003-2016, CKSource - Frederico Knabben. All rights reserved.
 * For licensing, see LICENSE.md or http://ckeditor.com/license
 */
"use strict";!function(){function e(e){function n(){this.deflated||(e.widgets.focused==this.widget&&(this.focused=!0),e.widgets.destroy(this.widget),this.deflated=!0)}function s(){var a=e.editable(),i=e.document;if(this.deflated){if(this.widget=e.widgets.initOn(this.element,"image",this.widget.data),this.widget.inline&&!new CKEDITOR.dom.elementPath(this.widget.wrapper,a).block){var n=i.createElement(e.activeEnterMode==CKEDITOR.ENTER_P?"p":"div");n.replace(this.widget.wrapper),this.widget.wrapper.move(n)}this.focused&&(this.widget.focus(),delete this.focused),delete this.deflated}else t(this.widget,o)}var o=e.config.image2_alignClasses,g=e.config.image2_captionedClass;return{allowedContent:d(e),requiredContent:"img[src,alt]",features:h(e),styleableElements:"img figure",contentTransformations:[["img[width]: sizeToAttribute"]],editables:{caption:{selector:"figcaption",allowedContent:"br em strong sub sup u s; a[!href]"}},parts:{image:"img",caption:"figcaption"},dialog:"image2",template:m,data:function(){var t=this.features;if(this.data.hasCaption&&!e.filter.checkFeature(t.caption)&&(this.data.hasCaption=!1),"none"==this.data.align||e.filter.checkFeature(t.align)||(this.data.align="none"),this.shiftState({widget:this,element:this.element,oldData:this.oldData,newData:this.data,deflate:n,inflate:s}),this.data.link?this.parts.link||(this.parts.link=this.parts.image.getParent()):this.parts.link&&delete this.parts.link,this.parts.image.setAttributes({src:this.data.src,"data-cke-saved-src":this.data.src,alt:this.data.alt}),this.oldData&&!this.oldData.hasCaption&&this.data.hasCaption)for(var a in this.data.classes)this.parts.image.removeClass(a);e.filter.checkFeature(t.dimension)&&r(this),this.oldData=CKEDITOR.tools.extend({},this.data)},init:function(){var t=CKEDITOR.plugins.image2,a=this.parts.image,i={hasCaption:!!this.parts.caption,src:a.getAttribute("src"),alt:a.getAttribute("alt")||"",width:a.getAttribute("width")||"",height:a.getAttribute("height")||"",lock:this.ready?t.checkHasNaturalRatio(a):!0},n=a.getAscendant("a");if(n&&this.wrapper.contains(n)&&(this.parts.link=n),!i.align){var s=i.hasCaption?this.element:a;o?(s.hasClass(o[0])?i.align="left":s.hasClass(o[2])&&(i.align="right"),i.align?s.removeClass(o[p[i.align]]):i.align="none"):(i.align=s.getStyle("float")||"none",s.removeStyle("float"))}if(e.plugins.link&&this.parts.link){i.link=t.getLinkAttributesParser()(e,this.parts.link);var r=i.link.advanced;r&&r.advCSSClasses&&(r.advCSSClasses=CKEDITOR.tools.trim(r.advCSSClasses.replace(/cke_\S+/,"")))}this.wrapper[(i.hasCaption?"remove":"add")+"Class"]("cke_image_nocaption"),this.setData(i),e.filter.checkFeature(this.features.dimension)&&e.config.image2_disableResizer!==!0&&l(this),this.shiftState=t.stateShifter(this.editor),this.on("contextMenu",function(e){e.data.image=CKEDITOR.TRISTATE_OFF,(this.parts.link||this.wrapper.getAscendant("a"))&&(e.data.link=e.data.unlink=CKEDITOR.TRISTATE_OFF)}),this.on("dialog",function(e){e.data.widget=this},this)},addClass:function(e){u(this).addClass(e)},hasClass:function(e){return u(this).hasClass(e)},removeClass:function(e){u(this).removeClass(e)},getClasses:function(){var e=new RegExp("^("+[].concat(g,o).join("|")+")$");return function(){var t=this.repository.parseElementClasses(u(this).getAttribute("class"));for(var a in t)e.test(a)&&delete t[a];return t}}(),upcast:a(e),downcast:i(e),getLabel:function(){var e=(this.data.alt||"")+" "+this.pathName;return this.editor.lang.widget.label.replace(/%1/,e)}}}function t(e,t){var a=e.wrapper,i=e.data.align,n=e.data.hasCaption;if(t){for(var s=3;s--;)a.removeClass(t[s]);"center"==i?n&&a.addClass(t[1]):"none"!=i&&a.addClass(t[p[i]])}else"center"==i?(n?a.setStyle("text-align","center"):a.removeStyle("text-align"),a.removeStyle("float")):("none"==i?a.removeStyle("float"):a.setStyle("float",i),a.removeStyle("text-align"))}function a(e){var t=n(e),a=e.config.image2_captionedClass;return function(e,i){var n,r={width:1,height:1},l=e.name;if(!e.attributes["data-cke-realelement"]){if(t(e)){if("div"==l){var o=e.getFirst("figure");o&&(e.replaceWith(o),e=o)}i.align="center",n=e.getFirst("img")||e.getFirst("a").getFirst("img")}else"figure"==l&&e.hasClass(a)?n=e.getFirst("img")||e.getFirst("a").getFirst("img"):s(e)&&(n="a"==e.name?e.children[0]:e);if(n){for(var g in r){var c=n.attributes[g];c&&c.match(v)&&delete n.attributes[g]}return e}}}}function i(e){var t=e.config.image2_alignClasses;return function(e){var a="a"==e.name?e.getFirst():e,i=a.attributes,n=this.data.align;if(!this.inline){var s=e.getFirst("span");s&&s.replaceWith(s.getFirst({img:1,a:1}))}if(n&&"none"!=n){var r=CKEDITOR.tools.parseCssText(i.style||"");"center"==n&&"figure"==e.name?e=e.wrapWith(new CKEDITOR.htmlParser.element("div",t?{"class":t[1]}:{style:"text-align:center"})):n in{left:1,right:1}&&(t?a.addClass(t[p[n]]):r["float"]=n),t||CKEDITOR.tools.isEmpty(r)||(i.style=CKEDITOR.tools.writeCssText(r))}return e}}function n(e){var t=e.config.image2_captionedClass,a=e.config.image2_alignClasses,i={figure:1,a:1,img:1};return function(n){if(!(n.name in{div:1,p:1}))return!1;var r=n.children;if(1!==r.length)return!1;var l=r[0];if(!(l.name in i))return!1;if("p"==n.name){if(!s(l))return!1}else if("figure"==l.name){if(!l.hasClass(t))return!1}else{if(e.enterMode==CKEDITOR.ENTER_P)return!1;if(!s(l))return!1}return(a?n.hasClass(a[1]):"center"==CKEDITOR.tools.parseCssText(n.attributes.style||"",!0)["text-align"])?!0:!1}}function s(e){return"img"==e.name?!0:"a"==e.name?1==e.children.length&&e.getFirst("img"):!1}function r(e){var t=e.data,a={width:t.width,height:t.height},i=e.parts.image;for(var n in a)a[n]?i.setAttribute(n,a[n]):i.removeAttribute(n)}function l(e){var t=e.editor,a=t.editable(),i=t.document,n=e.resizer=i.createElement("span");if(n.addClass("cke_image_resizer"),n.setAttribute("title",t.lang.image2.resizer),n.append(new CKEDITOR.dom.text("​",i)),e.inline)e.wrapper.append(n);else{var s=e.parts.link||e.parts.image,r=s.getParent(),l=i.createElement("span");l.addClass("cke_image_resizer_wrapper"),l.append(s),l.append(n),e.element.append(l,!0),r.is("span")&&r.remove()}n.on("mousedown",function(s){function r(e,t,a){var n=CKEDITOR.document,s=[];if(i.equals(n)||s.push(n.on(e,t)),s.push(i.on(e,t)),a)for(var r=s.length;r--;)a.push(s.pop())}function l(){h=T+k*f,u=Math.round(h/b)}function o(){u=E-p,h=Math.round(u*b)}function g(e){d=e.data.$,f=d.screenX-w,p=_-d.screenY,v=Math.abs(f/p),1==k?0>=f?0>=p?l():v>=b?l():o():0>=p?v>=b?o():l():o():0>=f?0>=p?v>=b?o():l():o():0>=p?l():v>=b?l():o(),h>=15&&u>=15?(C.setAttributes({width:h,height:u}),m=!0):m=!1}function c(){for(var i;i=D.pop();)i.removeListener();a.removeClass(I),n.removeClass("cke_image_resizing"),m&&(e.setData({width:h,height:u}),t.fire("saveSnapshot")),m=!1}var d,h,u,m,f,p,v,C=e.parts.image,k="right"==e.data.align?-1:1,w=s.data.$.screenX,_=s.data.$.screenY,T=C.$.clientWidth,E=C.$.clientHeight,b=T/E,D=[],I="cke_image_s"+(~k?"e":"w");t.fire("saveSnapshot"),r("mousemove",g,D),r("mouseup",c,D),a.addClass(I),n.addClass("cke_image_resizing")}),e.on("data",function(){n["right"==e.data.align?"addClass":"removeClass"]("cke_image_resizer_left")})}function o(e){var t,a=[];return function(i){var n=e.getCommand("justify"+i);n&&(a.push(function(){n.refresh(e,e.elementPath())}),i in{right:1,left:1,center:1}&&n.on("exec",function(t){var n=c(e);if(n){n.setData("align",i);for(var s=a.length;s--;)a[s]();t.cancel()}}),n.on("refresh",function(a){var n=c(e),s={right:1,left:1,center:1};n&&(void 0===t&&(t=e.filter.checkFeature(e.widgets.registered.image.features.align)),t?this.setState(n.data.align==i?CKEDITOR.TRISTATE_ON:i in s?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED):this.setState(CKEDITOR.TRISTATE_DISABLED),a.cancel())}))}}function g(e){e.plugins.link&&(CKEDITOR.on("dialogDefinition",function(t){var a=t.data;if("link"==a.name){var i=a.definition,n=i.onShow,s=i.onOk;i.onShow=function(){var t=c(e);t&&(t.inline?!t.wrapper.getAscendant("a"):1)?this.setupContent(t.data.link||{}):n.apply(this,arguments)},i.onOk=function(){var t=c(e);if(t&&(t.inline?!t.wrapper.getAscendant("a"):1)){var a={};this.commitContent(a),t.setData("link",a)}else s.apply(this,arguments)}}}),e.getCommand("unlink").on("exec",function(t){var a=c(e);a&&a.parts.link&&(a.setData("link",null),this.refresh(e,e.elementPath()),t.cancel())}),e.getCommand("unlink").on("refresh",function(t){var a=c(e);a&&(this.setState(a.data.link||a.wrapper.getAscendant("a")?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED),t.cancel())}))}function c(e){var t=e.widgets.focused;return t&&"image"==t.name?t:null}function d(e){var t=e.config.image2_alignClasses,a={div:{match:n(e)},p:{match:n(e)},img:{attributes:"!src,alt,width,height"},figure:{classes:"!"+e.config.image2_captionedClass},figcaption:!0};return t?(a.div.classes=t[1],a.p.classes=a.div.classes,a.img.classes=t[0]+","+t[2],a.figure.classes+=","+a.img.classes):(a.div.styles="text-align",a.p.styles="text-align",a.img.styles="float",a.figure.styles="float,display"),a}function h(e){var t=e.config.image2_alignClasses,a={dimension:{requiredContent:"img[width,height]"},align:{requiredContent:"img"+(t?"("+t[0]+")":"{float}")},caption:{requiredContent:"figcaption"}};return a}function u(e){return e.data.hasCaption?e.element:e.parts.image}var m='<img alt="" src="" />',f=new CKEDITOR.template('<figure class="{captionedClass}">'+m+"<figcaption>{captionPlaceholder}</figcaption></figure>"),p={left:0,center:1,right:2},v=/^\s*(\d+\%)\s*$/i;CKEDITOR.plugins.add("image2",{lang:"af,ar,bg,bn,bs,ca,cs,cy,da,de,de-ch,el,en,en-au,en-ca,en-gb,eo,es,et,eu,fa,fi,fo,fr,fr-ca,gl,gu,he,hi,hr,hu,id,is,it,ja,ka,km,ko,ku,lt,lv,mk,mn,ms,nb,nl,no,pl,pt,pt-br,ro,ru,si,sk,sl,sq,sr,sr-latn,sv,th,tr,tt,ug,uk,vi,zh,zh-cn",requires:"widget,dialog",icons:"image",hidpi:!0,onLoad:function(){CKEDITOR.addCss(".cke_image_nocaption{line-height:0}.cke_editable.cke_image_sw, .cke_editable.cke_image_sw *{cursor:sw-resize !important}.cke_editable.cke_image_se, .cke_editable.cke_image_se *{cursor:se-resize !important}.cke_image_resizer{display:none;position:absolute;width:10px;height:10px;bottom:-5px;right:-5px;background:#000;outline:1px solid #fff;line-height:0;cursor:se-resize;}.cke_image_resizer_wrapper{position:relative;display:inline-block;line-height:0;}.cke_image_resizer.cke_image_resizer_left{right:auto;left:-5px;cursor:sw-resize;}.cke_widget_wrapper:hover .cke_image_resizer,.cke_image_resizer.cke_image_resizing{display:block}.cke_widget_wrapper>a{display:inline-block}")},init:function(t){var a=t.config,i=t.lang.image2,n=e(t);a.filebrowserImage2BrowseUrl=a.filebrowserImageBrowseUrl,a.filebrowserImage2UploadUrl=a.filebrowserImageUploadUrl,n.pathName=i.pathName,n.editables.caption.pathName=i.pathNameCaption,t.widgets.add("image",n),t.ui.addButton&&t.ui.addButton("Image",{label:t.lang.common.image,command:"image",toolbar:"insert,10"}),t.contextMenu&&(t.addMenuGroup("image",10),t.addMenuItem("image",{label:i.menu,command:"image",group:"image"})),CKEDITOR.dialog.add("image2",this.path+"dialogs/image2.js")},afterInit:function(e){var t={left:1,right:1,center:1,block:1},a=o(e);for(var i in t)a(i);g(e)}}),CKEDITOR.plugins.image2={stateShifter:function(e){function t(e,t){var a={};l?a.attributes={"class":l[1]}:a.styles={"text-align":"center"};var i=r.createElement(e.activeEnterMode==CKEDITOR.ENTER_P?"p":"div",a);return s(i,t),t.move(i),i}function a(e){var t=e.findOne("a,img");return t.replace(e),t}function i(e,t){var a=r.createElement("a",{attributes:{href:t.url}});return a.replace(e),e.move(a),a}function n(e){var t=e.findOne("img");return t.replace(e),t}function s(t,a){if(a.getParent()){var i=e.createRange();i.moveToPosition(a,CKEDITOR.POSITION_BEFORE_START),a.remove(),g.insertElementIntoRange(t,i)}else t.replace(a)}var r=e.document,l=e.config.image2_alignClasses,o=e.config.image2_captionedClass,g=e.editable(),c=["hasCaption","align","link"],d={align:function(i,n,s){var r=i.element;i.changed.align?i.newData.hasCaption||("center"==s&&(i.deflate(),i.element=t(e,r)),i.changed.hasCaption||"center"!=n||"center"==s||(i.deflate(),i.element=a(r))):"center"==s&&i.changed.hasCaption&&!i.newData.hasCaption&&(i.deflate(),i.element=t(e,r)),!l&&r.is("figure")&&("center"==s?r.setStyle("display","inline-block"):r.removeStyle("display"))},hasCaption:function(t,a,i){if(t.changed.hasCaption){var n;if(n=t.element.is({img:1,a:1})?t.element:t.element.findOne("a,img"),t.deflate(),i){var l=CKEDITOR.dom.element.createFromHtml(f.output({captionedClass:o,captionPlaceholder:e.lang.image2.captionPlaceholder}),r);s(l,t.element),n.replace(l.findOne("img")),t.element=l}else n.replace(t.element),t.element=n}},link:function(t,a,s){if(t.changed.link){var r,l=t.element.is("img")?t.element:t.element.findOne("img"),o=t.element.is("a")?t.element:t.element.findOne("a"),g=t.element.is("a")&&!s||t.element.is("img")&&s;if(g&&t.deflate(),s){a||(r=i(l,t.newData.link));var c=CKEDITOR.plugins.image2.getLinkAttributesGetter()(e,s);CKEDITOR.tools.isEmpty(c.set)||(r||o).setAttributes(c.set),c.removed.length&&(r||o).removeAttributes(c.removed)}else r=n(o);g&&(t.element=r)}}};return function(e){var t,a;for(e.changed={},a=0;a<c.length;a++)t=c[a],e.changed[t]=e.oldData?e.oldData[t]!==e.newData[t]:!1;for(a=0;a<c.length;a++)t=c[a],d[t](e,e.oldData?e.oldData[t]:null,e.newData[t]);e.inflate()}},checkHasNaturalRatio:function(e){var t=e.$,a=this.getNatural(e);return Math.round(t.clientWidth/a.width*a.height)==t.clientHeight||Math.round(t.clientHeight/a.height*a.width)==t.clientWidth},getNatural:function(e){var t;if(e.$.naturalWidth)t={width:e.$.naturalWidth,height:e.$.naturalHeight};else{var a=new Image;a.src=e.getAttribute("src"),t={width:a.width,height:a.height}}return t},getLinkAttributesGetter:function(){return CKEDITOR.plugins.link.getLinkAttributes},getLinkAttributesParser:function(){return CKEDITOR.plugins.link.parseLinkAttributes}}}(),CKEDITOR.config.image2_captionedClass="image";