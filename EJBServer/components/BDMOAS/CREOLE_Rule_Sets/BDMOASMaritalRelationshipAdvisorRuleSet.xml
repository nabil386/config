<?xml version="1.0" encoding="UTF-8"?>
<RuleSet name="BDMOASMaritalRelationshipAdvisorRuleSet"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="http://www.curamsoftware.com/CreoleRulesSchema.xsd">

	<Class extends="AbstractAdviceContext"
		extendsRuleSet="CoreAdvisorRuleSet"
		name="BDMOASMaritalRelationshipAdviceContext"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xsi:noNamespaceSchemaLocation="http://www.curamsoftware.com/CreoleRulesSchema.xsd">

		<!-- This attribute value would be prepopulated by the propagator. -->
		<Attribute name="caseID">
			<type>
				<ruleclass name="NumberParameter"
					ruleset="CoreAdvisorRuleSet" />
			</type>
			<derivation>
				<specified />
			</derivation>
		</Attribute>

		<!-- This attribute value would be prepopulated by the propagator -->
		<Attribute name="adviceContextID">
			<type>
				<javaclass name="Number" />
			</type>
			<derivation>
				<specified />
			</derivation>
		</Attribute>

		<!-- This attribute will hold the list of advices which will be sent back 
			to the client -->
		<Attribute name="advice">
			<type>
				<javaclass name="List">
					<ruleclass name="AbstractAdviceItem"
						ruleset="CoreAdvisorRuleSet" />
				</javaclass>
			</type>
			<derivation>
				<fixedlist>
					<listof>
						<ruleclass name="AbstractAdviceItem"
							ruleset="CoreAdvisorRuleSet" />
					</listof>
					<members>
						<create ruleclass="BDMOASMaritalRelationshipAdviceItem">
							<reference attribute="value">
								<reference attribute="caseID" />
							</reference>
							<reference attribute="adviceContextID" />
						</create>
					</members>
				</fixedlist>
			</derivation>
		</Attribute>
	</Class>


	<Class name="BDMOASMaritalRelationshipAdviceItem"
		extends="AbstractAdviceItem" extendsRuleSet="CoreAdvisorRuleSet"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xsi:noNamespaceSchemaLocation="http://www.curamsoftware.com/CreoleRulesSchema.xsd">

		<Initialization>
			<Attribute name="caseIDParam">
				<type>
					<javaclass name="Number" />
				</type>
			</Attribute>
			<Attribute name="adviceContextID">
				<type>
					<javaclass name="Number" />
				</type>
			</Attribute>
		</Initialization>

		<Attribute name="caseID">
			<type>
				<javaclass name="Number" />
			</type>
			<derivation>
				<reference attribute="caseIDParam" />
			</derivation>
		</Attribute>

		<Attribute name="adviceText">
			<type>
				<javaclass name="String" />
			</type>
			<derivation>
				<String value="MaritalRelationshipTypeValidation" />
			</derivation>
		</Attribute>

		<Attribute name="category">
			<type>
				<codetableentry table="AdviceCategory" />
			</type>
			<derivation>
				<Code table="AdviceCategory">
					<String value="AC2000" />
				</Code>
			</derivation>
		</Attribute>

		<Attribute name="priority">
			<type>
				<codetableentry table="AdvicePriority" />
			</type>
			<derivation>
				<Code table="AdvicePriority">
					<String value="AP2000" />
				</Code>
			</derivation>
		</Attribute>

		<Attribute name="status">
			<type>
				<codetableentry table="AdviceStatus" />
			</type>
			<derivation>
				<Code table="AdviceStatus">
					<String value="AS2000" />
				</Code>
			</derivation>
		</Attribute>

		<Attribute name="evidenceType">
			<type>
				<codetableentry table="EvidenceType" />
			</type>
			<derivation>
				<Code table="EvidenceType">
					<String value="OASDET0010" />
				</Code>
			</derivation>
		</Attribute>

		<Attribute name="relatedID">
			<type>
				<javaclass name="Number" />
			</type>
			<derivation>
				<Number value="0" />
			</derivation>
		</Attribute>

		<Attribute name="showAdvice">
			<type>
				<javaclass name="Boolean" />
			</type>
			<derivation>
				<reference
					attribute="isMissingDateOfDeathForParticipantOrRelatedParticipant" />
			</derivation>
		</Attribute>

		<Attribute name="maritalRelationshipRecords">
			<type>
				<javaclass name="java.util.List">
					<ruleclass name="BDMOASMaritalRelationship"
						ruleset="BDMOASMaritalRelationshipVerDataRuleSet" />
				</javaclass>
			</type>
			<derivation>
				<readall ruleclass="BDMOASMaritalRelationship"
					ruleset="BDMOASMaritalRelationshipVerDataRuleSet">
					<match retrievedattribute="caseID">
						<reference attribute="caseID" />
					</match>
				</readall>
			</derivation>
		</Attribute>


		<Attribute
			name="isMissingDateOfDeathForParticipantOrRelatedParticipant">
			<type>
				<javaclass name="Boolean" />
			</type>
			<derivation>
				<any>
					<dynamiclist>
						<list alias="maritalRelationshipRecord">
							<reference attribute="maritalRelationshipRecords" />
						</list>
						<listitemexpression>
							<choose>
								<type>
									<javaclass name="Boolean" />
								</type>
								<when>
									<condition>
										<all>
											<fixedlist>
												<listof>
													<javaclass name="Boolean" />
												</listof>
												<members>
													<equals>
														<reference attribute="relationshipChangeType">
															<current alias="maritalRelationshipRecord" />
														</reference>
														<!-- 'MCT2' description 'Death' -->
														<Code table="BDMOASMaritalChangeType">
															<String value="MCT2" />
														</Code>
													</equals>
												</members>
											</fixedlist>
										</all>
									</condition>
									<value>
										<choose>
											<type>
												<javaclass name="Boolean" />
											</type>
											<when>
												<condition>
													<any>
														<fixedlist>
															<listof>
																<javaclass name="Boolean" />
															</listof>
															<members>
															<not>
																<equals>
																	<reference attribute="dateOfDeath">
																		<singleitem onEmpty="returnNull"
																			onMultiple="returnFirst">
																			<readall ruleclass="Person"
																				ruleset="ParticipantEntitiesRuleSet">
																				<match retrievedattribute="concernRoleID">
																					<reference attribute="participantRoleID">
																						<reference
																							attribute="related_caseParticipantRoleID">
																							<current
																								alias="maritalRelationshipRecord" />
																						</reference>
																					</reference>
																				</match>
																			</readall>
																		</singleitem>
																	</reference>
																	<null />
																</equals>
															</not>
																<all>
																	<fixedlist>
																		<listof>
																			<javaclass name="Boolean" />
																		</listof>
																		<members>
																			<not>
																				<equals>
																					<reference
																						attribute="relatedCaseParticipantRoleID">
																						<current alias="maritalRelationshipRecord" />
																					</reference>
																					<Number value="0" />
																				</equals>
																			</not>
																			<not>
																			<equals>
																				<reference attribute="dateOfDeath">
																					<singleitem onEmpty="returnNull"
																						onMultiple="returnFirst">
																						<readall ruleclass="Person"
																							ruleset="ParticipantEntitiesRuleSet">
																							<match retrievedattribute="concernRoleID">
																								<reference
																									attribute="participantRoleID">
																									<reference
																										attribute="related_relatedCaseParticipantRoleID">
																										<current
																											alias="maritalRelationshipRecord" />
																									</reference>
																								</reference>
																							</match>
																						</readall>
																					</singleitem>
																				</reference>
																				<null />
																			</equals>
																			</not>
																		</members>
																	</fixedlist>
																</all>
															</members>
														</fixedlist>
													</any>
												</condition>
												<value>
													<false />
												</value>
											</when>
											<otherwise>
												<value>
													<true />
												</value>
											</otherwise>
										</choose>
									</value>
								</when>
								<otherwise>
									<value>
										<false />
									</value>
								</otherwise>
							</choose>
						</listitemexpression>
					</dynamiclist>
				</any>
			</derivation>
		</Attribute>
	</Class>
</RuleSet>