<?xml version="1.0" encoding="UTF-8"?>
<!-- 64790: Residence Period -->
<RuleSet name="OASResidencePeriodValidationRuleSet"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="http://www.curamsoftware.com/CreoleRulesSchema.xsd">
	<Class extends="DefaultEvidenceValidationResult"
		extendsRuleSet="EvidenceValidationRuleSet" name="ValidationResult">
		<Attribute name="description">
			<type>
				<javaclass name="curam.creole.value.Message" />
			</type>
			<derivation>
				<ResourceMessage key="Description"
					resourceBundle="curam.ca.gc.bdmoas.evidence.OASResidencePeriodValidationRuleSet" />
			</derivation>
		</Attribute>
		<Attribute name="evidence">
			<type>
				<ruleclass name="OASResidencePeriod"
					ruleset="OASResidencePeriodRuleSet" />
			</type>
			<derivation>
				<specified />
			</derivation>
		</Attribute>
		<Attribute name="standardValidations">
			<type>
				<javaclass name="java.util.List">
					<ruleclass name="Validation"
						ruleset="EvidenceValidationRuleSet" />
				</javaclass>
			</type>
			<derivation>
				<fixedlist>
					<listof>
						<ruleclass name="Validation"
							ruleset="EvidenceValidationRuleSet" />
					</listof>
					<members>
						<reference attribute="absenceDataForbiddenValidation" />
						<reference attribute="foreignResidenceOverlapValidation" />
					</members>
				</fixedlist>
			</derivation>
		</Attribute>
		<Attribute name="absenceDataForbiddenValidation">
			<type>
				<ruleclass name="Validation"
					ruleset="EvidenceValidationRuleSet" />
			</type>
			<derivation>
				<create ruleclass="Validation"
					ruleset="EvidenceValidationRuleSet">
					<reference attribute="absenceDataForbiddenFailure" />
					<reference attribute="absenceDataForbiddenFailureMessage" />
				</create>
			</derivation>
		</Attribute>
		<Attribute name="absenceDataForbiddenFailure">
			<type>
				<javaclass name="java.lang.Boolean" />
			</type>
			<derivation>
				<choose>
					<type>
						<javaclass name="java.lang.Boolean" />
					</type>
					<when>
						<condition>
							<equals>
								<reference attribute="country">
									<reference attribute="evidence" />
								</reference>
								<Code table="Country">
									<String value="CA" />
								</Code>
							</equals>
						</condition>
						<value>
							<any>
								<fixedlist>
									<listof>
										<javaclass name="java.lang.Boolean" />
									</listof>
									<members>
										<not>
											<equals>
												<reference attribute="absenceReason">
													<reference attribute="evidence" />
												</reference>
												<null />
											</equals>
										</not>
										<not>
											<equals>
												<reference attribute="intentToReturnYesNo">
													<reference attribute="evidence" />
												</reference>
												<null />
											</equals>
										</not>
									</members>
								</fixedlist>
							</any>
						</value>
					</when>
					<otherwise>
						<value>
							<false />
						</value>
					</otherwise>
				</choose>
			</derivation>
		</Attribute>

		<Attribute name="absenceDataForbiddenFailureMessage">
			<type>
				<javaclass name="curam.creole.value.Message" />
			</type>
			<derivation>
				<ResourceMessage key="ERR_ABSENCE_DATA_FORBIDDEN"
					resourceBundle="curam.ca.gc.bdmoas.evidence.OASResidencePeriodValidationRuleSet" />
			</derivation>
		</Attribute>
        
        <Attribute name="foreignResidenceOverlapValidation">
            <type>
                <ruleclass name="Validation"
                    ruleset="EvidenceValidationRuleSet" />
            </type>
            <derivation>
                <create ruleclass="Validation"
                    ruleset="EvidenceValidationRuleSet">
                    <reference attribute="foreignResidenceOverlapValidationFailure" />
                    <reference attribute="foreignResidenceOverlapValidationFailureMessage" />
                </create>
            </derivation>
        </Attribute>
        
        <Attribute name="foreignResidenceOverlapValidationFailure">
            <type>
                <javaclass name="java.lang.Boolean" />
            </type>
            <derivation>
                <all>
                    <fixedlist>
                        <listof>
                            <javaclass name="Boolean" />
                        </listof>
                        <members>
                            <reference attribute="isCanadianResidenceMet" />
                            <reference attribute="isForeignResidenceAndCanadianResidenceOverlapping" />
                        </members>
                    </fixedlist>
                </all>
            </derivation>
        </Attribute>

        <Attribute name="foreignResidenceOverlapValidationFailureMessage">
            <type>
                <javaclass name="curam.creole.value.Message" />
            </type>
            <derivation>
                <ResourceMessage key="ERR_OVERLAPPING_FOREIGN_RESIDENCE_PERIOD"
                    resourceBundle="curam.ca.gc.bdmoas.evidence.OASResidencePeriodValidationRuleSet" />
            </derivation>
        </Attribute>
        
        <Attribute name="isCanadianResidenceMet">
            <type>
                <javaclass name="Boolean" />
            </type>
            <derivation>
                <all>
                    <fixedlist>
                        <listof>
                            <javaclass name="Boolean" />
                        </listof>
                        <members>
                            <equals>
                                <reference attribute="country">
                                    <reference attribute="evidence" />
                                </reference>
                                <Code table="Country">
                                    <String value="CA" />
                                </Code>
                            </equals>
                            <any>
                                <fixedlist>
                                    <listof>
                                        <javaclass name="Boolean" />
                                    </listof>
                                    <members>
                                        <!-- Residence -->
                                        <equals>
                                            <Code table="OASResidenceType">
                                                <String value="RT001" />
                                            </Code>
                                            <reference attribute="residenceType">
                                                <reference attribute="evidence" />
                                            </reference>
                                        </equals>
                                        <!-- Deemed Residence -->
                                        <equals>
                                            <Code table="OASResidenceType">
                                                <String value="RT004" />
                                            </Code>
                                            <reference attribute="residenceType">
                                                <reference attribute="evidence" />
                                            </reference>
                                        </equals>
                                    </members>
                                </fixedlist>
                            </any>
                        </members>
                    </fixedlist>
                </all>
            </derivation>
        </Attribute>
        
        <Attribute name="isForeignResidenceAndCanadianResidenceOverlapping">
            <type>
                <javaclass name="Boolean" />
            </type>
            <derivation>
                <any>
                    <dynamiclist>
                        <list>
                            <reference attribute="foreignResidencePeriods" />
                        </list>
                        <listitemexpression>
                            <any>
                                <fixedlist>
                                    <listof>
                                        <javaclass name="Boolean" />
                                    </listof>
                                    <members>
                                        <property name="valueOn">
                                            <object>
                                                <reference attribute="exists">
                                                    <current />
                                                </reference>
                                            </object>
                                            <arguments>
                                                <reference attribute="startDate">
                                                    <reference attribute="evidence" />
                                                </reference>
                                            </arguments>
                                        </property>
                                        <property name="valueOn">
                                            <object>
                                                <reference attribute="exists">
                                                    <current />
                                                </reference>
                                            </object>
                                            <arguments>
                                                <reference attribute="endDate">
                                                    <reference attribute="evidence" />
                                                </reference>
                                            </arguments>
                                        </property>
                                        <property name="valueOn">
                                            <object>
                                                <reference attribute="existenceTimeline">
                                                    <reference attribute="residencePeriodObject" />
                                                </reference>
                                            </object>
                                            <arguments>
                                                <reference attribute="startDate">
                                                    <current />
                                                </reference>
                                            </arguments>
                                        </property>
                                        <property name="valueOn">
                                            <object>
                                                <reference attribute="existenceTimeline">
                                                    <reference attribute="residencePeriodObject" />
                                                </reference>
                                            </object>
                                            <arguments>
                                                <reference attribute="endDate">
                                                    <current />
                                                </reference>
                                            </arguments>
                                        </property>
                                    </members>
                                </fixedlist>
                            </any>
                        </listitemexpression>
                    </dynamiclist>
                </any>
            </derivation>
        </Attribute>
        
        <Attribute name="foreignResidencePeriods">
            <type>
                <javaclass name="List">
                    <ruleclass name="BDMForeignResidencePeriod"
                        ruleset="BDMForeignResidencePeriodDataRuleSet" />
                </javaclass>
            </type>
            <derivation>
                <joinlists>
                    <dynamiclist>
                        <list>
                            <reference attribute="participantIntegratedCaseHeaders" />
                        </list>
                        <listitemexpression>
                            <readall ruleclass="BDMForeignResidencePeriod"
                                ruleset="BDMForeignResidencePeriodDataRuleSet">
                                <match retrievedattribute="caseID">
                                    <reference attribute="caseID">
                                        <current />
                                    </reference>
                                </match>
                            </readall>
                        </listitemexpression>
                    </dynamiclist>
                </joinlists>
            </derivation>
        </Attribute>
        
        <Attribute name="residencePeriodObject">
            <type>
                <ruleclass name="OASResidencePeriodObject"/>
            </type>
            <derivation>
                <create ruleclass="OASResidencePeriodObject">
                    <reference attribute="evidence" />
                </create>
            </derivation>
        </Attribute>
        
        <Attribute name="participantIntegratedCaseHeaders">
            <type>
                <javaclass name="List">
                    <ruleclass name="CaseHeader"
                        ruleset="CaseEntitiesRuleSet" />
                </javaclass>
            </type>
            <derivation>
                <filter>
                    <list>
                        <readall ruleclass="CaseHeader"
                            ruleset="CaseEntitiesRuleSet">
                            <match
                                retrievedattribute="concernRoleID">
                                <reference attribute="participantRoleID">
                                    <reference
                                        attribute="related_caseParticipantRole">
                                        <reference attribute="evidence" />
                                    </reference>
                                </reference>
                            </match>
                        </readall>
                    </list>
                    <listitemexpression>
                        <equals>
                            <reference
                                attribute="caseTypeCode">
                                <current />
                            </reference>
                            <Code table="CaseTypeCode">
                                <String value="CT5" />
                            </Code>
                        </equals>
                    </listitemexpression>
                </filter>
            </derivation>
        </Attribute>
	</Class>
    
    <Class name="OASResidencePeriodObject">
        <Initialization>
            <Attribute name="evidence">
                <type>
                    <ruleclass name="OASResidencePeriod"
                        ruleset="OASResidencePeriodRuleSet" />
                </type>
            </Attribute>
        </Initialization>
        <Attribute name="existenceTimeline">
            <type>
                <javaclass name="curam.creole.value.Timeline">
                    <javaclass name="Boolean" />
                </javaclass>
            </type>
            <derivation>
                <existencetimeline>
                    <intervaltype>
                        <javaclass name="java.lang.Boolean" />
                    </intervaltype>
                    <intervalfromdate>
                        <reference attribute="startDate">
                            <reference attribute="evidence" />
                        </reference>
                    </intervalfromdate>
                    <intervaltodate>
                        <reference attribute="endDate">
                            <reference attribute="evidence" />
                        </reference>
                    </intervaltodate>
                    <preExistenceValue>
                        <false />
                    </preExistenceValue>
                    <existenceValue>
                        <true />
                    </existenceValue>
                    <postExistenceValue>
                        <false />
                    </postExistenceValue>
                </existencetimeline>
            </derivation>
        </Attribute>
    </Class>
</RuleSet>