<?xml version="1.0" encoding="UTF-8"?>
<!-- 64796 DEV: Implement First Entry Into Canada Details -->
<RuleSet name="BDMOASFirstEntryIntoCanadaDetailsValidationRuleSet"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="http://www.curamsoftware.com/CreoleRulesSchema.xsd">
    <Class extends="DefaultEvidenceValidationResult" extendsRuleSet="EvidenceValidationRuleSet" name="ValidationResult">
        
       <Attribute name="description">
            <type>
                <javaclass name="curam.creole.value.Message" />
            </type>
            <derivation>
                <ResourceMessage key="Description"
                    resourceBundle="curam.ca.gc.bdmoas.evidence.BDMOASFirstEntryIntoCanadaDetailsValidationRuleSet" />
            </derivation>
        </Attribute>
        <Attribute name="evidence">
            <type>
                <ruleclass
                    name="BDMOASFirstEntryIntoCanadaDetails"
                    ruleset="BDMOASFirstEntryIntoCanadaDetailsRuleSet" />
            </type>
            <derivation>
                <specified />
            </derivation>
        </Attribute>
        <Attribute name="standardValidations">
            <type>
                <javaclass name="java.util.List">
                    <ruleclass name="Validation"
                        ruleset="EvidenceValidationRuleSet" />
                </javaclass>
            </type>
            <derivation>
                <fixedlist>
                    <listof>
                        <ruleclass name="Validation"
                            ruleset="EvidenceValidationRuleSet" />
                    </listof>
                    <members>
                        <reference attribute="dateOfArrivalOnOrBeforeDodValidation" />
                        <reference attribute="countryOfBirthCanadaValidation" />
                    </members>
                </fixedlist>
            </derivation>
        </Attribute>

        <Attribute name="dateOfArrivalOnOrBeforeDodValidation">
            <type>
                <ruleclass name="Validation"
                    ruleset="EvidenceValidationRuleSet" />
            </type>
            <derivation>
                <create ruleclass="Validation"
                    ruleset="EvidenceValidationRuleSet">
                    <reference
                        attribute="dateOfArrivalOnOrBeforeDodFailure" />
                    <reference
                        attribute="dateOfArrivalOnOrBeforeDodFailureMessage" />
                </create>
            </derivation>
        </Attribute>
        
        <Attribute name="dateOfArrivalOnOrBeforeDodFailure">
            <type>
                <javaclass name="java.lang.Boolean" />
            </type>
            <derivation>
                <choose>
                    <type>
                        <javaclass name="Boolean" />
                    </type>
                    <when>
                        <condition>
                            <reference attribute="dateOfDeathExists" />
                        </condition>
                        <value>
                            <compare comparison=">">
                                <reference attribute="arrivalDate">
                                    <reference attribute="evidence" />
                                </reference>
                                <reference attribute="dateOfDeath">
                                    <reference attribute="birthAndDeathEvidence" />
                                </reference>
                            </compare>
                        </value>
                    </when>
                    <otherwise>
                        <value>
                            <false />
                        </value>
                    </otherwise>
                </choose>
            </derivation>
        </Attribute>
        
        <Attribute name="dateOfArrivalOnOrBeforeDodFailureMessage">
            <type>
                <javaclass name="curam.creole.value.Message" />
            </type>
            <derivation>
                <ResourceMessage
                    key="ERR_DATE_OF_ARRIVAL_AFTER_DOD"
                    resourceBundle="curam.ca.gc.bdmoas.evidence.BDMOASFirstEntryIntoCanadaDetailsValidationRuleSet" />
            </derivation>
        </Attribute>
        
        <Attribute name="countryOfBirthCanadaValidation">
            <type>
                <ruleclass name="Validation"
                    ruleset="EvidenceValidationRuleSet" />
            </type>
            <derivation>
                <create ruleclass="Validation"
                    ruleset="EvidenceValidationRuleSet">
                    <reference
                        attribute="countryOfBirthCanadaValidationFailure" />
                    <reference
                        attribute="countryOfBirthCanadaValidationFailureMessage" />
                </create>
            </derivation>
        </Attribute>
        
        <Attribute name="countryOfBirthCanadaValidationFailure">
            <type>
                <javaclass name="java.lang.Boolean" />
            </type>
            <derivation>
                <choose>
                    <type>
                        <javaclass name="Boolean" />
                    </type>
                    <when>
                        <condition>
                            <reference attribute="countryOfBirthExists" />
                        </condition>
                        <value>
                            <equals>
                                <Code table="Country">
                                    <String value="CA" />
                                </Code>
                                <reference attribute="countryOfBirth">
                                    <reference attribute="birthAndDeathEvidence" />
                                </reference>
                            </equals>
                        </value>
                    </when>
                    <otherwise>
                        <value>
                            <false />
                        </value>
                    </otherwise>
                </choose>
            </derivation>
        </Attribute>
        
        <Attribute name="countryOfBirthCanadaValidationFailureMessage">
            <type>
                <javaclass name="curam.creole.value.Message" />
            </type>
            <derivation>
                <ResourceMessage
                    key="ERR_FIRST_ENTRY_PROHIBITED_FOR_COUNTRY_OF_BIRTH"
                    resourceBundle="curam.ca.gc.bdmoas.evidence.BDMOASFirstEntryIntoCanadaDetailsValidationRuleSet">
                    <reference attribute="concernRoleName" />
                 </ResourceMessage>
            </derivation>
        </Attribute>
        
        <Attribute name="countryOfBirthExists">
            <type>
                <javaclass name="java.lang.Boolean"/>
            </type>
            <derivation>
                <not>
                    <equals>
                        <null />
                        <reference attribute="countryOfBirth">
                            <reference attribute="birthAndDeathEvidence" />
                        </reference>
                    </equals>
                </not>
            </derivation>
        </Attribute>
        
        <Attribute name="concernRoleName">
            <type>
                <javaclass name="String" />
            </type>
            <derivation>
                <call class="curam.ca.gc.bdm.creole.impl.Statics" method="getParticipantNameFromCaseParticipantRoleID">
                    <type>
                        <javaclass name="String" />
                    </type>
                    <arguments>
                        <reference attribute="caseParticipantRole">
                            <reference attribute="evidence" />
                        </reference>
                    </arguments>
                </call>
            </derivation>
        </Attribute>
        
        <Attribute name="dateOfDeathExists">
            <type>
                <javaclass name="java.lang.Boolean"/>
            </type>
            <derivation>
                <choose>
                    <type>
                        <javaclass name="java.lang.Boolean" />
                    </type>
                    <when>
                        <condition>
                            <not>
                                <equals>
                                    <null />
                                    <reference attribute="dateOfDeath">
                                        <reference attribute="birthAndDeathEvidence" />
                                    </reference>
                                </equals>
                            </not>
                        </condition>
                        <value>
                            <true />
                        </value>
                    </when>
                    <otherwise>
                        <value>
                            <false />
                        </value>
                    </otherwise>
                </choose>
            </derivation>
        </Attribute>

        <Attribute name="birthAndDeathEvidence">
            <type>
                <ruleclass name="PDCBirthAndDeath"
                    ruleset="PDCBirthAndDeathDataRuleSet" />
            </type>
            <derivation>
                <singleitem onMultiple="returnFirst"
                    onEmpty="error">
                    <readall ruleclass="PDCBirthAndDeath"
                        ruleset="PDCBirthAndDeathDataRuleSet">
                        <match retrievedattribute="caseID">
                            <reference attribute="caseID">
                                <reference
                                    attribute="participantDataCaseHeader" />
                            </reference>
                        </match>
                    </readall>
                </singleitem>
            </derivation>
        </Attribute>

        <Attribute name="participantRoleID">
            <type>
                <javaclass name="java.lang.Number" />
            </type>
            <derivation>
                <reference attribute="participantRoleID">
                    <reference
                        attribute="related_caseParticipantRole">
                        <reference attribute="evidence" />
                    </reference>
                </reference>
            </derivation>
        </Attribute>

        <Attribute name="participantDataCaseHeader">
            <type>
                <ruleclass name="CaseHeader"
                    ruleset="CaseEntitiesRuleSet" />
            </type>
            <derivation>
                <singleitem onMultiple="returnFirst"
                    onEmpty="error">
                    <filter>
                        <list>
                            <readall ruleclass="CaseHeader"
                                ruleset="CaseEntitiesRuleSet">
                                <match
                                    retrievedattribute="concernRoleID">
                                    <reference
                                        attribute="participantRoleID" />
                                </match>
                            </readall>
                        </list>
                        <listitemexpression>
                            <equals>
                                <reference
                                    attribute="caseTypeCode">
                                    <current />
                                </reference>
                                <Code table="CaseTypeCode">
                                    <String value="CT2001" />
                                </Code>
                            </equals>
                        </listitemexpression>
                    </filter>
                </singleitem>
            </derivation>
        </Attribute>
        
    </Class>
    
</RuleSet>
