<?xml version="1.0" encoding="UTF-8"?>
<RuleSet name="BDMOASMaritalStatusVerificationRuleSet"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="http://www.curamsoftware.com/CreoleRulesSchema.xsd">
    <Class extends="VerificationDeterminator"
        extendsRuleSet="VerificationRuleSet"
        name="BDMOASMaritalStatusVerificationDeterminator">

        <Attribute name="displayName">
            <type>
                <javaclass name="curam.creole.value.Message" />
            </type>
            <derivation>
                <XmlMessage>BDMOASMaritalStatusVerification</XmlMessage>
            </derivation>
        </Attribute>

        <Attribute name="determine">
            <type>
                <ruleclass
                    name="VerificationDeterminatorResult"
                    ruleset="VerificationRuleSet" />
            </type>
            <derivation>
                <create
                    ruleclass="VerificationDeterminatorResult"
                    ruleset="VerificationRuleSet">
                    <specify attribute="result">
                        <reference attribute="isVerificationRequired" />
                    </specify>
                    <specify attribute="reason">
                        <reference attribute="reasonSkipped" />
                    </specify>
                </create>
            </derivation>
        </Attribute>

        <Attribute name="reasonSkipped">
            <type>
                <codetableentry table="VerificationSkippedReason" />
            </type>
            <derivation>
                <Code table="VerificationSkippedReason">
                    <String value="BDMVSR2001" />
                </Code>
            </derivation>
        </Attribute>

        <Attribute name="maritalStatusEvidenceRecord">
            <type>
                <ruleclass name="BDMMaritalStatus"
                    ruleset="BDMMaritalStatusVerDataRuleSet" />
            </type>
            <derivation>
                <singleitem onMultiple="returnFirst"
                    onEmpty="returnNull">
                    <readall ruleclass="BDMMaritalStatus"
                        ruleset="BDMMaritalStatusVerDataRuleSet">
                        <match
                            retrievedattribute="evidenceDescriptorID">
                            <reference
                                attribute="evidenceDescriptorID">
                                <reference
                                    attribute="verificationDeterminatorParams" />
                            </reference>
                        </match>
                    </readall>
                </singleitem>
            </derivation>
        </Attribute>
        
        <Attribute name="isVerificationRequired">
            <type>
                <javaclass name="Boolean" />
            </type>
            <derivation>
                <not>
                    <any>
                        <fixedlist>
                            <listof>
                                <javaclass name="Boolean" />
                            </listof>
                            <members>
                                <!-- Marital Status is not Single -->
                                <not>
                                    <equals>
                                        <Code table="BDMMaritalStatus">
                                            <String value="MS1" />
                                        </Code>
                                        <reference attribute="maritalStatus">
                                            <reference attribute="maritalStatusEvidenceRecord" />
                                        </reference>
                                    </equals>
                                </not>
                                <all>
                                    <fixedlist>
                                        <listof>
                                            <javaclass name="Boolean" />
                                        </listof>
                                        <members>
                                            <!-- Marital Status is Single -->
                                            <equals>
                                                <Code table="BDMMaritalStatus">
                                                    <String value="MS1" />
                                                </Code>
                                                <reference attribute="maritalStatus">
                                                    <reference attribute="maritalStatusEvidenceRecord" />
                                                </reference>
                                            </equals>
                                            <!-- CRA Marital Status exists -->
                                            <reference attribute="isCRAMaritalStatusRecordExists" />
                                            <!-- CRA Marital Status matches Marital Status details -->
                                            <equals>
                                                <!-- CRA Marital Status is Single -->
                                                <Code table="BDMOASCRAMaritalStatus">
                                                    <String value="MST7" />
                                                </Code>
                                                <reference attribute="maritalStatus">
                                                    <reference attribute="craMartialStatusRecord" />
                                                </reference>
                                            </equals>
                                        </members>
                                    </fixedlist>
                                </all>
                                <all>
                                    <fixedlist>
                                        <listof>
                                            <javaclass name="Boolean" />
                                        </listof>
                                        <members>
                                            <!-- Marital Status is Single -->
                                            <equals>
                                                <Code table="BDMMaritalStatus">
                                                    <String value="MS1" />
                                                </Code>
                                                <reference attribute="maritalStatus">
                                                    <reference attribute="maritalStatusEvidenceRecord" />
                                                </reference>
                                            </equals>
                                            <!-- CRA Marital Status not exists -->
                                            <not>
                                                <reference attribute="isCRAMaritalStatusRecordExists" />
                                            </not>
                                        </members>
                                    </fixedlist>
                                </all>
                            </members>
                        </fixedlist>
                    </any>
                </not>
            </derivation>
        </Attribute>
        
        <Attribute name="craMartialStatusRecord">
            <type>
                <ruleclass name="BDMOASCRAMaritalStatus" ruleset="BDMOASCRAMaritalStatusDataRuleSet"/>
            </type>
            <derivation>
                <reference attribute="craMaritalStatusRecord">
                    <reference attribute="caseParticipantData">
                        <create ruleclass="BDMOASParticipantCalculator"
                            ruleset="BDMOASParticipantCalculatorRuleSet">
                            <reference attribute="caseParticipantRoleID">
                                <reference attribute="maritalStatusEvidenceRecord" />
                            </reference>
                        </create>
                    </reference>
                </reference>
            </derivation>
        </Attribute>
        
        <Attribute name="isCRAMaritalStatusRecordExists">
            <type>
                <javaclass name="Boolean" />
            </type>
            <derivation>
                <not>
                    <equals>
                        <null />
                        <reference attribute="craMartialStatusRecord" />
                    </equals>
                </not>
            </derivation>
        </Attribute>
    </Class>
</RuleSet>