<?xml version="1.0" encoding="UTF-8"?>

<RuleSet
  name="BDMAddressPCRRuleSet"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:noNamespaceSchemaLocation="http://www.curamsoftware.com/CreoleRulesSchema.xsd"
>


  <Class
    extends="AbstractPCR"
    extendsRuleSet="PCRRuleSet"
    name="BDMAddressPCR"
  >
<Annotations>
  <Label label-id="BDMAddressPCR.label.1" name="BDM Address Integrity Rules PCR Rules Class"/>
</Annotations>
<Attribute name="caseID">
      <type>
        <javaclass name="Number"/>
      </type>
      <derivation>
        <specified/>
      </derivation>
    </Attribute>

    <Attribute name="priorityRate">
      <type>
        <javaclass name="Number"/>
      </type>
      <derivation>
        <null/>
      </derivation>
    </Attribute>

    <Attribute name="priorityReason">
      <type>
        <javaclass name="curam.creole.value.Message"/>
      </type>
      <derivation>
        <null/>
      </derivation>
    </Attribute>

    <Attribute name="complexityRate">
      <type>
        <javaclass name="Number"/>
      </type>
      <derivation>
        <null/>
      </derivation>
    </Attribute>

    <Attribute name="complexityReason">
      <type>
        <javaclass name="curam.creole.value.Message"/>
      </type>
      <derivation>
        <null/>
      </derivation>
    </Attribute>

    <Attribute name="riskRate">
		<type>
			<javaclass name="Number"/>        
		</type>
		<derivation>
			<choose>
				<type>
					<javaclass name="Number"/>
				</type>
				<when>
					<condition>
						<reference attribute="isRiskConditionMet"/>
					</condition>
					<value>
						<Number value="2"/>
					</value>
				</when>
				<otherwise>
					<value>
						<Number value="0"/>
					</value>
				</otherwise>
			</choose>
		</derivation>
	</Attribute>

    <Attribute name="riskReason">
		<type>
			<javaclass name="curam.creole.value.Message"/>        
		</type>
		<derivation>
			<choose>
				<type>
					<javaclass name="curam.creole.value.Message"/>
				</type>
				<when>
					<condition>
						<reference attribute="isRiskConditionMet"/>
					</condition>
					<value>
						<XmlMessage>Address failing Address Integrity Limit Check</XmlMessage>
					</value>
				</when>
				<otherwise>
					<value>
						<XmlMessage>Address passing Address Integrity Limit Check</XmlMessage>
					</value>
				</otherwise>
			</choose>
		</derivation>
	</Attribute>
	
	<Attribute name="isRiskConditionMet">
		<type>
			<javaclass name="Boolean"/>
		</type>
		<derivation>
			<any>
				<fixedlist>
					<listof>
						<javaclass name="Boolean"/>
					</listof>
					<members>
						<reference attribute="individualPerAddressUseCountAboveThreshold"/>
						<reference attribute="benefitPerAddressUseCountAboveThreshold"/>
					</members>
				</fixedlist>
			</any>
		</derivation>
	</Attribute>
	
	<!-- Individual Per Address -->
	<Attribute name="individualPerAddressCountThresholdLimit">
		<type>
			<javaclass name="Number"/>        
		</type>
		<derivation>
			<call class="curam.ca.gc.bdm.creole.impl.BDMVerificationStatics" method="getIndividualPerAddressLimit">
			<type>
				<javaclass name="Number"/>  
			</type>
			<arguments/>
			</call>
		</derivation>
	</Attribute>
	
	<Attribute name="individualPerAddressUseCountAboveThreshold">
		<Annotations>
		  <Label label-id="BDMAddressPCR.label.2" name="BDM Address Integrity Rules - IntegrityRule0002 - Address Rules"/>
		</Annotations>
		<type>
			<javaclass name="Boolean"/>
		</type>
		<derivation>
			<compare comparison="&gt;">
				<reference attribute="individualPerAddressUseCount"/>
				<reference attribute="individualPerAddressCountThresholdLimit"/>							  
			</compare>
		</derivation>
	</Attribute>
	<Attribute name="individualPerAddressUseCount">
		<type>
			<javaclass name="Number"/>        
		</type>
		<derivation>
			<choose>
				<type>
					<javaclass name="Number"/>
				</type>
				<when>
					<condition>
						<not>
							<equals>
								<reference attribute="addressEvidenceRecord"/>									
								<null />
							</equals>
						</not>
					</condition>
					<value>
						<call class="curam.ca.gc.bdm.creole.impl.BDMVerificationStatics" method="getIndividualPerAddressUseCount">
						<type>
							<javaclass name="Number"/>  
						</type>
							<arguments>
								<reference attribute="addressData">
									<reference attribute="related_address">
										<reference attribute="addressEvidenceRecord"/>
									</reference>
								</reference>	
								<reference attribute="addressType">
									<reference attribute="addressEvidenceRecord"/>
								</reference>
							</arguments>
						</call>
					</value>
				</when>
				<otherwise>
					<value>
						<Number value="0"/>
					</value>
				</otherwise>
			</choose>
		</derivation>
	</Attribute>
	<!-- Benefit Per Address -->
	<Attribute name="benefitPerAddressCountThresholdLimit">
		<type>
			<javaclass name="Number"/>        
		</type>
		<derivation>
			<call class="curam.ca.gc.bdm.creole.impl.BDMVerificationStatics" method="getBenefitPerAddressLimit">
			<type>
				<javaclass name="Number"/>  
			</type>
			<arguments/>
			</call>
		</derivation>
	</Attribute>
	<Attribute name="benefitPerAddressUseCountAboveThreshold">
		<Annotations>
		  <Label label-id="BDMAddressPCR.label.3" name="BDM Address Integrity Rules - IntegrityRule0003 - Address Rules"/>
		</Annotations>
		<type>
			<javaclass name="Boolean"/>
		</type>
		<derivation>
			<compare comparison="&gt;">
				<reference attribute="benefitPerAddressUseCount"/>
				<reference attribute="benefitPerAddressCountThresholdLimit"/>							  
			</compare>
		</derivation>
	</Attribute>
	
	<Attribute name="benefitPerAddressUseCount">
		<type>
			<javaclass name="Number"/>        
		</type>
		<derivation>
			<choose>
				<type>
					<javaclass name="Number"/>
				</type>
				<when>
					<condition>
						<not>
							<equals>
								<reference attribute="addressEvidenceRecord"/>									
								<null />
							</equals>
						</not>
					</condition>
					<value>
						<call class="curam.ca.gc.bdm.creole.impl.BDMVerificationStatics" method="getBenefitPerAddressUseCount">
						<type>
							<javaclass name="Number"/>  
						</type>
							<arguments>
								<reference attribute="addressData">
									<reference attribute="related_address">
										<reference attribute="addressEvidenceRecord"/>
									</reference>
								</reference>	
								<reference attribute="addressType">
									<reference attribute="addressEvidenceRecord"/>
								</reference>
							</arguments>
							
						</call>
					</value>
				</when>
				<otherwise>
					<value>
						<Number value="0"/>
					</value>
				</otherwise>
			</choose>
		</derivation>
	</Attribute>
		
	<Attribute name="addressEvidenceRecord">
		<type>
			<ruleclass name="PDCAddress" ruleset="PDCAddressDataRuleSet"/>        
		</type>
		<derivation>
			<singleitem onMultiple="returnFirst" onEmpty="returnNull">
				<readall ruleclass="PDCAddress" ruleset="PDCAddressDataRuleSet">
					<match retrievedattribute="caseID">
						<reference attribute="caseID"/>                                
					</match>
				</readall>
			</singleitem>
		</derivation>
	</Attribute>

  </Class>

</RuleSet>
