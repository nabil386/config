<?xml version="1.0" encoding="UTF-8"?>
<RuleSet name="BDMIncarcerationValidationRuleSet">

	<!-- Validation Ruleset for Incarceration Evidence.-->
		
	<Class extends="DefaultEvidenceValidationResult"
		extendsRuleSet="EvidenceValidationRuleSet" name="ValidationResult">
		
		<!-- Setting rule class to IncarcerationRuleSet -->
		<Attribute name="evidence">
			<type>
				<ruleclass name="Incarceration" ruleset="IncarcerationRuleSet" />
			</type>
			<derivation>
				<specified />
			</derivation>
		</Attribute>
		
<Attribute name="evidenceSuccessionID">
	<type>
		<javaclass name="Number" />
	</type>
	<derivation>
		<reference attribute="successionID">
			<reference attribute="evidence" />
		</reference>
	</derivation>
</Attribute>

  <Attribute name="caseID">
	<type>
		<javaclass name="Number"/>
	</type>
	<derivation>
		<reference attribute="caseID">
			<reference attribute="evidence" />
		</reference>
	</derivation>
</Attribute>
<!--  get list of all incarceration evidecne for given caseID -->
	<Attribute name="incarcerationEvidence">
		<type>
			<javaclass name="List">
				<ruleclass name="Incarceration"
					ruleset="IncarcerationDataRuleSet" />
			</javaclass>
		</type>
		<derivation>
			<readall ruleclass="Incarceration"
				ruleset="IncarcerationDataRuleSet">
				<match retrievedattribute="caseID">
					<reference attribute="caseID" />
				</match>
			</readall>
		</derivation>
	</Attribute>
		
		<!--OOTB Attribute that needs to be initialized-->
		<Attribute name="standardValidations">
			<type>
				<javaclass name="List">
					<ruleclass name="Validation"
						ruleset="EvidenceValidationRuleSet" />
				</javaclass>
			</type>
			<derivation>
				<reference attribute="incarcerationStandardValidations" />
			</derivation>
		</Attribute>

		<Attribute name="incarcerationStandardValidations">
			<type>
				<javaclass name="List">
					<ruleclass name="Validation"
						ruleset="EvidenceValidationRuleSet" />
				</javaclass>
			</type>
			<derivation>
				<fixedlist>
					<listof>
						<ruleclass name="Validation"
							ruleset="EvidenceValidationRuleSet" />
					</listof>
					<members>
						<reference attribute="incarcerationDateOverlapValidation" />
					</members>
				</fixedlist>
			</derivation>
		</Attribute>
		
		
		
		
		<!-- Multiple incarceration overlapping time periods cannot exist -->
		
		<Attribute name="incarcerationDateOverlapValidation">
		<type>
			<ruleclass name="Validation"
				ruleset="EvidenceValidationRuleSet" />
		</type>
		<derivation>
			<choose>
				<type>
					<ruleclass name="Validation"
						ruleset="EvidenceValidationRuleSet" />
				</type>
				<when>
					<condition>
						<not>
							<equals>
								<reference attribute="endDate">
									<reference attribute="evidence" />
								</reference>
								<null />
							</equals>
						</not>
					</condition>
					<value>
						<create ruleclass="Validation"
								ruleset="EvidenceValidationRuleSet">
								
								<reference attribute="validateDateOverlap" />
								
								<ResourceMessage
									key="ERR_OVERLAPPING_TIME_NOT_ALLOWED"
									resourceBundle="curam.bdm.pdc.rules.BDMIncarcerationValidationRuleSet">
								
								<reference attribute="incarcerationStartDate"/>
								<reference attribute="incarcerationEndDate"/>	
								</ResourceMessage>
							</create>
					</value>
				</when>
				<otherwise>
					<value>
						<create ruleclass="Validation"
									ruleset="EvidenceValidationRuleSet">
									
									<reference attribute="validateDateOverlap" />
									
									<ResourceMessage
										key="ERR_OVERLAPPING_TIME_NOT_ALLOWED"
										resourceBundle="curam.bdm.pdc.rules.BDMIncarcerationValidationRuleSet">
									
									<reference attribute="incarcerationStartDate"/>
									</ResourceMessage>
						</create>
					</value>
				</otherwise>
			</choose>
			
		</derivation>
	</Attribute>
	
	
	<Attribute name="incarcerationStartDate">
		<type>
			<javaclass name="String"/>
		</type>
		<derivation>
			<call class="curam.ca.gc.bdm.creole.impl.Statics" method="getStringDate">
        		<type>
					<javaclass name="String"/>
				</type>
			    <arguments>
			        <reference attribute="startDate">
			        	<reference attribute="evidence"/>
			        </reference>	
			    </arguments>
			</call>
		</derivation>
	</Attribute>
	
	<Attribute name="incarcerationEndDate">
		<type>
			<javaclass name="String"/>
		</type>
		<derivation>
			<call class="curam.ca.gc.bdm.creole.impl.Statics" method="getStringDate">
        		<type>
					<javaclass name="String"/>
				</type>
			    <arguments>
			        <reference attribute="startDate">
			        	<reference attribute="evidence"/>
			        </reference>	
			    </arguments>
			</call>
		</derivation>
	</Attribute>
	
	
	<Attribute name="validateDateOverlap">
	<type>
		<javaclass name="Boolean" />
	</type>
	<derivation>
		<choose>
			<type>
				<javaclass name="Boolean" />
			</type>
			<when>
				<condition>
					<not>
						<equals>
							<reference attribute="endDate">
								<reference attribute="evidence" />
							</reference>
							<null />
						</equals>
					</not>
				</condition>
				<value>
					<reference attribute="validateOverlapWithEndDate" />
				</value>
			</when>
			<otherwise>
				<value>
					<reference attribute="validateOverlapNoEndDate" />
				</value>
			</otherwise>
		</choose>
	</derivation>
</Attribute>
	
	
	<!-- Check if there there is overlap with end date -->
	
	<Attribute name="validateOverlapWithEndDate">
	<type>
		<javaclass name="Boolean" />
	</type>
	<derivation>
		<any>
			<dynamiclist>
				<list>
					<reference
						attribute="incarcerationEvidenceForClient" />
				</list>
				<listitemexpression>
					<choose>
						<type>
							<javaclass name="Boolean" />
						</type>
						<when>
							<condition>
								<all>
									<fixedlist>
										<listof>
											<javaclass name="Boolean" />
										</listof>
										<members>
											<any>
												<fixedlist>
													<listof>
														<javaclass name="Boolean" />
													</listof>
													<members>
														<compare comparison="&lt;=">
															<reference attribute="startDate">
																<reference attribute="evidence" />
															</reference>
															<reference attribute="endDate">
																<current />
															</reference>
														</compare>
														<equals>
															<reference attribute="endDate">
																<current />
															</reference>
															<null />
														</equals>
													</members>
												</fixedlist>
											</any>
											<compare comparison="&gt;=">
												<reference attribute="endDate">
													<reference attribute="evidence" />
												</reference>
												<reference attribute="startDate">
													<current />
												</reference>
											</compare>
										</members>
									</fixedlist>
								</all>
							</condition>
							<value>
								<true />
							</value>
						</when>
						<otherwise>
							<value>
								<false />
							</value>
						</otherwise>
					</choose>
				</listitemexpression>
			</dynamiclist>
		</any>
	</derivation>
</Attribute>
	<Attribute name="validateOverlapNoEndDate">
		<type>
			<javaclass name="Boolean" />
		</type>
		<derivation>
			<any>
				<dynamiclist>
					<list>
						<reference
							attribute="incarcerationEvidenceForClient" />
					</list>
					<listitemexpression>
						<choose>
							<type>
								<javaclass name="Boolean" />
							</type>
							<when>
								<condition>
									<any>
										<fixedlist>
											<listof>
												<javaclass name="Boolean" />
											</listof>
											<members>
												<equals>
													<reference attribute="endDate">
														<current />
													</reference>
													<null />
												</equals>
												<compare comparison="&lt;=">
													<reference attribute="startDate">
														<reference attribute="evidence" />
													</reference>
													<reference attribute="endDate">
														<current />
													</reference>
												</compare>
											</members>
										</fixedlist>
									</any>
								</condition>
								<value>
									<true />
								</value>
							</when>
							<otherwise>
								<value>
									<false />
								</value>
							</otherwise>
						</choose>
					</listitemexpression>
				</dynamiclist>
			</any>
		</derivation>
	</Attribute>
	
	
	<!-- Get list of all incarceration evidence -->
	
<Attribute name="incarcerationEvidenceForClient">
	<type>
		<javaclass name="List">
			<ruleclass name="Incarceration"
				ruleset="IncarcerationDataRuleSet" />
		</javaclass>
	</type>
	<derivation>
		<filter>
			<list>
				<reference attribute="incarcerationEvidence" />
			</list>
			<listitemexpression>
				<all>
					<fixedlist>
						<listof>
							<javaclass name="Boolean" />
						</listof>
						<members>
							<not>
								<equals>

									<reference attribute="evidenceSuccessionID" />
									<reference attribute="successionID">
										<current />
									</reference>
								</equals>
							</not>
							
							<equals>

								<reference attribute="participantRoleID">
									<reference attribute="related_caseParticipant">
										<reference attribute="evidence" />
									</reference>
								</reference>
								<reference attribute="participantRoleID">
									<reference attribute="related_caseParticipant">
										<current />
									</reference>
								</reference>
							</equals>
						</members>
					</fixedlist>
				</all>
			</listitemexpression>
		</filter>
	</derivation>
</Attribute>
</Class>

</RuleSet>
