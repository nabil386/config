<RuleSet name="BDMEvolutionRuleSet">

	<!-- BDMCase -->
	<!-- An evolution base class representative of a BDM case -->
	<Class name="BDMCase">
	
		<Annotations>
		  <Label label-id="BDMCase.label.1" name="BDM Case"/>
		</Annotations>
	
		<!--  Initialization -->
	
		<Initialization>
			<!-- ID of the integrated case this class should be built up around -->
			<Attribute name="integratedCaseID">
				<type>
					<javaclass name="Number" />
				</type>
			</Attribute>
		</Initialization>
		
		<!-- List of application submission dates, taken from application submission evidence -->
		<Attribute name="applicationSubmissionDates">
			<type>
				<javaclass name="List">
					<javaclass name="curam.util.type.Date"/>
				</javaclass>
			</type>
			<derivation>
				<!-- TODO: once application submission evidence is designed, switch this over to reference it rather than using this static, then get rid of the static entirely -->
				<fixedlist>
					<listof>
						<javaclass name="curam.util.type.Date"/>
					</listof>
					<members>
						<call class="curam.ca.gc.bdm.creole.impl.Statics" method="getApplicationSubmissionDate">
						  <type>
							<javaclass name="curam.util.type.Date"/>
						  </type>
						  <arguments>		          
							<reference attribute="integratedCaseID"/> 
						  </arguments>
						</call>
					</members>
				</fixedlist>
			</derivation>
		</Attribute>
		
		<!-- List of all case participant roles on the integrated case -->
		<Attribute name="caseParticipantRoles">
			<type>
				<javaclass name="List">
					<ruleclass
						name="CaseParticipantRole"
						ruleset="CaseEntitiesRuleSet"/>
				</javaclass>
			</type>
			<derivation>
				<filter>
					<list>
						<readall ruleclass="CaseParticipantRole" ruleset="CaseEntitiesRuleSet">
							<match retrievedattribute="caseID">
								<reference attribute="integratedCaseID"/>
							</match>
						</readall>
					</list>
					<listitemexpression>
						<any>
							<fixedlist>
								<listof>
									<javaclass name="Boolean"/>
								</listof>
								<members>
									<equals>
										<reference attribute="typeCode">
											<current/>
										</reference>
										<Code table="CaseParticipantRoleType">
											<String value="MEM"/>
										</Code>
									</equals>
									<equals>
										<reference attribute="typeCode">
											<current/>
										</reference>
										<Code table="CaseParticipantRoleType">
											<String value="PRI"/>
										</Code>
									</equals>
								</members>
							</fixedlist>
						</any>
					</listitemexpression>
				</filter>
			</derivation>
		</Attribute>
		
		<!-- Case participant role record belonging to the applicant / primary (PRI) member of the integrated case -->
		<Attribute name="applicantCaseParticipantRole">
			<type>
				<ruleclass name="CaseParticipantRole" ruleset="CaseEntitiesRuleSet"/>
			</type>
			<derivation>
				<singleitem onEmpty="returnNull" onMultiple="returnFirst">
					<filter>
						<list>
							<reference attribute="caseParticipantRoles"/>
						</list>
						<listitemexpression>
							<equals>
								<reference attribute="typeCode">
									<current/>
								</reference>
								<Code table="CaseParticipantRoleType">
									<String value="PRI"/>
								</Code>
							</equals>
						</listitemexpression>
					</filter>
				</singleitem>
			</derivation>
		</Attribute>
		
		<!-- List of all non-primary (MEM) case participant roles on the integrated case -->
		<Attribute name="nonApplicantCaseParticipantRoleList">
			<type>
				<javaclass name="List">
					<ruleclass name="CaseParticipantRole" ruleset="CaseEntitiesRuleSet"/>
				</javaclass>
			</type>
			<derivation>
					<filter>
						<list>
							<reference attribute="caseParticipantRoles"/>
						</list>
						<listitemexpression>
							<equals>
								<reference attribute="typeCode">
									<current/>
								</reference>
								<Code table="CaseParticipantRoleType">
									<String value="MEM"/>
								</Code>
							</equals>
						</listitemexpression>
					</filter>
			</derivation>
		</Attribute>
		
		<!-- BDMMemberCPR evolution class for the applicant / primary (PRI) member on the integrated case -->
		<Attribute name="applicantMemberCPR">
			<type>
				<ruleclass name="BDMMemberCPR"/>
			</type>
			<derivation>
				<create ruleclass="BDMMemberCPR">
					<specify attribute="caseParticipantRoleRecord">
						<reference attribute="applicantCaseParticipantRole"/>
					</specify>
				</create>
			</derivation>
		</Attribute>
		
		<!-- List of BDMMemberCPR evolution classes for all non-primary (MEM) case participant roles on the integrated case -->
		<Attribute name="nonApplicantMemberCPRList">
			<type>
				<javaclass name="List">
					<ruleclass name="BDMMemberCPR"/>
				</javaclass>
			</type>
			<derivation>
				<dynamiclist>
					<list>
						<reference attribute="nonApplicantCaseParticipantRoleList"/>
					</list>
					<listitemexpression>
						<create ruleclass="BDMMemberCPR">
							<specify attribute="caseParticipantRoleRecord">
								<current/>
							</specify>
						</create>
					</listitemexpression>
				</dynamiclist>
			</derivation>
		</Attribute>
		
		<!-- Evidences at the IC level -->
		
		<!-- A list of the members incarceration evidences -->
		<Attribute name="incarcerationEvidenceList">
			<type>
				<javaclass name="List">
					<ruleclass 
						name="BDMIncarceration"
						ruleset="BDMIncarcerationDataRuleSet"/>
				</javaclass>
			</type>
			<derivation>
				<readall ruleclass="BDMIncarceration"
					ruleset="BDMIncarcerationDataRuleSet">
					<match retrievedattribute="caseID">
						<reference attribute="integratedCaseID"/>
					</match>
				</readall>
			</derivation>
		</Attribute>
		
		<!-- A list of the members income evidences -->
		<Attribute name="incomeEvidenceList">
			<type>
				<javaclass name="List">
					<ruleclass 
						name="Income"
						ruleset="IncomeDataRuleSet"/>
				</javaclass>
			</type>
			<derivation>
				<readall ruleclass="Income"
					ruleset="IncomeDataRuleSet">
					<match retrievedattribute="caseID">
						<reference attribute="integratedCaseID"/>
					</match>
				</readall>
			</derivation>
		</Attribute>
	</Class>
	
	

	<!-- BDMMemberCPR -->
	<!-- An evolution class representative of a person. Contains only program/benefit-agnostic person-level evidences -->
	<Class name="BDMMemberCPR">
	
		<Annotations>
		  <Label label-id="BDMMemberCPR.label.1" name="BDM Member CPR"/>
		</Annotations>
	
		<!-- Initialization -->

		<!-- Case Participant Role record from the participant's integrated case that this class should be built up around -->
		<Attribute name="caseParticipantRoleRecord">
			<type>
				<ruleclass
					name="CaseParticipantRole"
					ruleset="CaseEntitiesRuleSet" />
			</type>
			<derivation>
				<specified/>
			</derivation>
		</Attribute>
		
		<!-- Integate Case ID from the caseParticipantRoleRecord -->
		<Attribute name="integratedCaseID">
			<type>
				<javaclass name="Number"/>
			</type>
			<derivation>
				<reference attribute="caseID">
					<reference attribute="caseParticipantRoleRecord"/>
				</reference>
			</derivation>
		</Attribute>
		
		<!-- A reference to the Participant Data Case associated with this object's Case Participant Role -->
		<Attribute name="participantDataCaseHeader">
			<type>
				<ruleclass name="CaseHeader" ruleset="CaseEntitiesRuleSet" />
			</type>
			<derivation>
				<singleitem onEmpty="returnNull" onMultiple="returnFirst">
					<filter>
						<list>
							<readall ruleclass="CaseHeader" ruleset="CaseEntitiesRuleSet">
								<match retrievedattribute="concernRoleID">
									<reference attribute="participantRoleID">
										<reference attribute="caseParticipantRoleRecord"/>
									</reference>
								</match>
							</readall>
						</list>
						<listitemexpression>
							<equals>
								<reference attribute="caseTypeCode">
									<current />
								</reference>
								<Code table="CaseTypeCode">
									<String value="CT2001" />
								</Code>
							</equals>
						</listitemexpression>
					</filter>
				</singleitem>
			</derivation>
		</Attribute>

		<!-- Evidences -->
		
		<!-- The member's name evidence record-->
		<Attribute name="pdcName">
			<type>
				<ruleclass name="PDCName"
					ruleset="PDCNameDataRuleSet" />
			</type>
			<derivation>
				<!-- singleitem is used since a person should only ever have 1 piece of this evidence -->
				<singleitem onEmpty="returnNull" onMultiple="returnFirst">
					<readall ruleclass="PDCName"
						ruleset="PDCNameDataRuleSet">
						<match retrievedattribute="caseID">
							<reference attribute="caseID">
								<reference attribute="participantDataCaseHeader" />
							</reference>
						</match>
					</readall>
				</singleitem>
			</derivation>
		</Attribute>
		
		<!-- The member's birthAndDeathDetails evidence record-->
		<Attribute name="birthAndDeathRecord">
			<type>
				<ruleclass name="BirthAndDeathEvidence"
					ruleset="ParticipantEvidenceRuleSet" />
			</type>
			<derivation>
				<!-- singleitem is used since a person should only ever have 1 piece of this evidence -->
				<singleitem onEmpty="returnNull" onMultiple="returnFirst">
					<readall ruleclass="BirthAndDeathEvidence"
						ruleset="ParticipantEvidenceRuleSet">
						<match retrievedattribute="caseID">
							<reference attribute="caseID">
								<reference attribute="participantDataCaseHeader" />
							</reference>
						</match>
					</readall>
				</singleitem>
			</derivation>
		</Attribute>

		<!-- A list of the member's identification evidence -->
		<Attribute name="identificationsRecords">
			<type>
				<javaclass name="List">
					<ruleclass 
						name="IdentificationEvidence"
						ruleset="ParticipantEvidenceRuleSet"/>
				</javaclass>
			</type>
			<derivation>
				<readall
					ruleclass="IdentificationEvidence"
					ruleset="ParticipantEvidenceRuleSet">
					<match retrievedattribute="caseID">
						<reference attribute="caseID">
							<reference attribute="participantDataCaseHeader"/>
						</reference>
					</match>
				</readall>
			</derivation>
		</Attribute>
	</Class>

</RuleSet>