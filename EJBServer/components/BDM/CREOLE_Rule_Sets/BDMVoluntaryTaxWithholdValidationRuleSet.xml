<?xml version="1.0" encoding="UTF-8"?>
<RuleSet name="BDMVoluntaryTaxWithholdValidationRuleSet">


	<Class extends="DefaultEvidenceValidationResult"
		extendsRuleSet="EvidenceValidationRuleSet" name="ValidationResult">
		
		<!-- Setting rule class to BDMVoluntaryTaxWithhold -->
		<Attribute name="evidence">
			<type>
				<ruleclass name="BDMVoluntaryTaxWithhold" ruleset="BDMVoluntaryTaxWithholdRuleSet" />
			</type>
			<derivation>
				<specified />
			</derivation>
		</Attribute>
		<Attribute name="evidenceSuccessionID">
	<type>
		<javaclass name="Number" />
	</type>
	<derivation>
		<reference attribute="successionID">
			<reference attribute="evidence" />
		</reference>
	</derivation>
</Attribute>

  <Attribute name="caseID">
	<type>
		<javaclass name="Number"/>
	</type>
	<derivation>
		<reference attribute="caseID">
			<reference attribute="evidence" />
		</reference>
	</derivation>
</Attribute>
		<!--OOTB Attribute that needs to be initialized-->
		<Attribute name="standardValidations">
			<type>
				<javaclass name="List">
					<ruleclass name="Validation"
						ruleset="EvidenceValidationRuleSet" />
				</javaclass>
			</type>
			<derivation>
				<reference attribute="voluntaryTaxWithHoldValidations"/>
			</derivation>
		</Attribute>
		
		<Attribute name="vtwEvidence">
		<type>
			<javaclass name="List">
				<ruleclass name="BDMVoluntaryTaxWithhold"
				ruleset="BDMVoluntaryTaxWithholdDataRuleSet" />
			</javaclass>
		</type>
		<derivation>
			<readall ruleclass="BDMVoluntaryTaxWithhold"
				ruleset="BDMVoluntaryTaxWithholdDataRuleSet">
				<match retrievedattribute="caseID">
					<reference attribute="caseID" />
				</match>
			</readall>
		</derivation>
	</Attribute>

		<Attribute name="voluntaryTaxWithHoldValidations">
			<type>
				<javaclass name="List">
					<ruleclass name="Validation"
						ruleset="EvidenceValidationRuleSet" />
				</javaclass>
			</type>
			<derivation>
				<fixedlist>
					<listof>
						<ruleclass name="Validation"
							ruleset="EvidenceValidationRuleSet" />
					</listof>
					<members>
						<reference attribute="validateTaxWithholdType" />
						<reference attribute="validateAmountAndPercentageEntered" />
						<reference attribute="validateAmountAndPercentageNotEntered" />
						<reference attribute="VTWDateOverlapValidation"/>
						<reference attribute="validateAmountEntered"/>
						<reference attribute="validatePercentageEntered"/>
						<reference attribute="percentageOrAmountIsChanged"/>
						<reference attribute="modifyVTWEvidence"/>
					</members>
				</fixedlist>
			</derivation>
		</Attribute>
		
		<Attribute name="validateAmountAndPercentageNotEntered">
			<type>
				<ruleclass name="Validation"
					ruleset="EvidenceValidationRuleSet" />
			</type>
			<derivation>
				<create ruleclass="Validation"
					ruleset="EvidenceValidationRuleSet">
				<reference attribute="isAmountAndPercentageNotEnteredValidation" />
					<ResourceMessage key="ERR_PERCENTAGE_AMOUNT_SHOULD_BE_ENTERED"
						resourceBundle="curam.bdm.pdc.rules.BDMVoluntaryTaxWithholdValidationRuleSet">
					</ResourceMessage>
				</create>
			</derivation>
		</Attribute>
		<!--  validation message when amount and percentage is entered -->
		<Attribute name="isAmountAndPercentageNotEnteredValidation">
			<type>
				<javaclass name="Boolean"/>
			</type>
			<derivation>
				<choose>
					<type>
						<javaclass name="Boolean"/>
					</type>
				<when>
					<condition>
						<all>
							<fixedlist>
								<listof>
									<javaclass name="Boolean"/>
								</listof>
								<members>
									<equals>
										<reference attribute="amount">
											<reference attribute="evidence" />
										 </reference>
										 <Number value="0"/>
									</equals>
									<equals>
										<reference attribute="percentageValue">
											<reference attribute="evidence" />
										 </reference>
										 <Number value="0"/>
									</equals>
								</members>
							</fixedlist>
						</all>
					</condition>
					<value>
						<true/>
					</value>
				</when>
				<otherwise>
					<value>
						<false/>
					</value>
				</otherwise>
				</choose>
			</derivation>
		</Attribute>
		
		
		<Attribute name="validateAmountAndPercentageEntered">
			<type>
				<ruleclass name="Validation"
					ruleset="EvidenceValidationRuleSet" />
			</type>
			<derivation>
				<create ruleclass="Validation"
					ruleset="EvidenceValidationRuleSet">
				<reference attribute="isAmountAndPercentageEnteredValidation" />
					<ResourceMessage key="ERR_PERCENTAGE_AMOUNT_NOT_VALID"
						resourceBundle="curam.bdm.pdc.rules.BDMVoluntaryTaxWithholdValidationRuleSet">
					</ResourceMessage>
				</create>
			</derivation>
		</Attribute>
		
		<!--  validation message when amount and percentage is entered -->
		<Attribute name="isAmountAndPercentageEnteredValidation">
			<type>
				<javaclass name="Boolean"/>
			</type>
			<derivation>
				<choose>
					<type>
						<javaclass name="Boolean"/>
					</type>
				<when>
					<condition>
						<all>
							<fixedlist>
								<listof>
									<javaclass name="Boolean"/>
								</listof>
								<members>
									<not>
										<equals>
											<reference attribute="amount">
												<reference attribute="evidence" />
											 </reference>
											 <Number value="0"/>
										</equals>
									</not>
									<not>
										<equals>
											<reference attribute="percentageValue">
												<reference attribute="evidence" />
											 </reference>
											 <Number value="0"/>
										</equals>
									</not>
								</members>
							</fixedlist>
						</all>
					</condition>
					<value>
						<true/>
					</value>
				</when>
				<otherwise>
					<value>
						<false/>
					</value>
				</otherwise>
				</choose>
			</derivation>
		</Attribute>
		<!-- Overlapping validation Start  -->
		
		<Attribute name="VTWDateOverlapValidation">
		<type>
			<ruleclass name="Validation"
				ruleset="EvidenceValidationRuleSet" />
		</type>
		<derivation>
			<choose>
				<type>
					<ruleclass name="Validation"
						ruleset="EvidenceValidationRuleSet" />
				</type>
				<when>
					<condition>
						<not>
							<equals>
								<reference attribute="endDate">
									<reference attribute="evidence" />
								</reference>
								<null />
							</equals>
						</not>
					</condition>
					<value>
						<create ruleclass="Validation"
								ruleset="EvidenceValidationRuleSet">
								
								<reference attribute="validateDateOverlap" />
								
								<ResourceMessage
									key="ERR_OVERLAPPING_TIME_NOT_ALLOWED"
									resourceBundle="curam.bdm.pdc.rules.BDMVoluntaryTaxWithholdValidationRuleSet">
								
								<reference attribute="vtwStartDate"/>
								<reference attribute="vtwEndDate"/>	
								</ResourceMessage>
							</create>
					</value>
				</when>
				<otherwise>
					<value>
						<create ruleclass="Validation"
									ruleset="EvidenceValidationRuleSet">
									
									<reference attribute="validateDateOverlap" />
									
									<ResourceMessage
										key="ERR_OVERLAPPING_TIME_NOT_ALLOWED"
										resourceBundle="curam.bdm.pdc.rules.BDMVoluntaryTaxWithholdValidationRuleSet">
									
									<reference attribute="vtwStartDate"/>
									</ResourceMessage>
						</create>
					</value>
				</otherwise>
			</choose>
			
		</derivation>
	</Attribute>
	
	
	<Attribute name="vtwStartDate">
		<type>
			<javaclass name="String"/>
		</type>
		<derivation>
			<call class="curam.ca.gc.bdm.creole.impl.Statics" method="getStringDate">
        		<type>
					<javaclass name="String"/>
				</type>
			    <arguments>
			        <reference attribute="startDate">
			        	<reference attribute="evidence"/>
			        </reference>	
			    </arguments>
			</call>
		</derivation>
	</Attribute>
	
	<Attribute name="vtwEndDate">
		<type>
			<javaclass name="String"/>
		</type>
		<derivation>
			<call class="curam.ca.gc.bdm.creole.impl.Statics" method="getStringDate">
        		<type>
					<javaclass name="String"/>
				</type>
			    <arguments>
			        <reference attribute="startDate">
			        	<reference attribute="evidence"/>
			        </reference>	
			    </arguments>
			</call>
		</derivation>
	</Attribute>
	 <!-- BEGIN TASK 19341 -validate if percentage number or dollar amount is changed..-->
	<Attribute name="percentageOrAmountIsChanged">
	<type>
		<ruleclass name="Validation"
			ruleset="EvidenceValidationRuleSet" />
	</type>
	<derivation>
		<create ruleclass="Validation"
			ruleset="EvidenceValidationRuleSet">
			<reference attribute="isPercentageOrAmountIsChanged" />
			<ResourceMessage
				key="ERR_CHANGE_PER_NO_OR_DOLLAR_AMOUNT"
				resourceBundle="curam.bdm.pdc.rules.BDMVoluntaryTaxWithholdValidationRuleSet">
			</ResourceMessage>
		</create>
	</derivation>
</Attribute>
	<Attribute name="isPercentageOrAmountIsChanged">
		<type>
			<javaclass name="Boolean" />
		</type>
		<derivation>
			<call class="curam.ca.gc.bdm.creole.impl.Statics"
				method="isPercentageOrAmountIsChanged">
				<type>
					<javaclass name="Boolean" />
				</type>
				<arguments>
					<reference attribute="evidence" />
				</arguments>
			</call>
		</derivation>
	</Attribute>
	<!-- END TASK 19341 -validate if percentage number or dollar amount is changed..-->
	
	 <!-- BEGIN TASK 56063 -validate if VTW Can be modified or not.-->
	<Attribute name="modifyVTWEvidence">
	<type>
		<ruleclass name="Validation"
			ruleset="EvidenceValidationRuleSet" />
	</type>
	<derivation>
		<create ruleclass="Validation"
			ruleset="EvidenceValidationRuleSet">
			<reference attribute="canModifyVTWEvidence" />
			<ResourceMessage
				key="ERR_VTW_CANNOT_MODIFY"
				resourceBundle="curam.bdm.pdc.rules.BDMVoluntaryTaxWithholdValidationRuleSet">
			</ResourceMessage>
		</create>
	</derivation>
</Attribute>
	<Attribute name="canModifyVTWEvidence">
		<type>
			<javaclass name="Boolean" />
		</type>
		<derivation>
			<call class="curam.ca.gc.bdm.creole.impl.Statics"
				method="canVTWModified">
				<type>
					<javaclass name="Boolean" />
				</type>
				<arguments>
					<reference attribute="evidence" />
				</arguments>
			</call>
		</derivation>
	</Attribute>
	<!-- END TASK 56063 -validate if VTW Can be modified or not.-->
	
	<Attribute name="validateDateOverlap">
	<type>
		<javaclass name="Boolean" />
	</type>
	<derivation>
		<choose>
			<type>
				<javaclass name="Boolean" />
			</type>
			<when>
				<condition>
					<not>
						<equals>
							<reference attribute="endDate">
								<reference attribute="evidence" />
							</reference>
							<null />
						</equals>
					</not>
				</condition>
				<value>
					<reference attribute="validateOverlapWithEndDate" />
				</value>
			</when>
			<otherwise>
				<value>
					<reference attribute="validateOverlapNoEndDate" />
				</value>
			</otherwise>
		</choose>
	</derivation>
</Attribute>
	
	
	<!-- Check if there there is overlap with end date -->
	
	<Attribute name="validateOverlapWithEndDate">
	<type>
		<javaclass name="Boolean" />
	</type>
	<derivation>
		<any>
			<dynamiclist>
				<list>
					<reference
						attribute="vtwEvidenceForClient" />
				</list>
				<listitemexpression>
					<choose>
						<type>
							<javaclass name="Boolean" />
						</type>
						<when>
							<condition>
								<all>
									<fixedlist>
										<listof>
											<javaclass name="Boolean" />
										</listof>
										<members>
											<any>
												<fixedlist>
													<listof>
														<javaclass name="Boolean" />
													</listof>
													<members>
														<compare comparison="&lt;=">
															<reference attribute="startDate">
																<reference attribute="evidence" />
															</reference>
															<reference attribute="endDate">
																<current />
															</reference>
														</compare>
														<equals>
															<reference attribute="endDate">
																<current />
															</reference>
															<null />
														</equals>
													</members>
												</fixedlist>
											</any>
											<compare comparison="&gt;=">
												<reference attribute="endDate">
													<reference attribute="evidence" />
												</reference>
												<reference attribute="startDate">
													<current />
												</reference>
											</compare>
											<equals>
													<reference attribute="voluntaryTaxWithholdType">
														<reference attribute="evidence" />
													</reference>
													<reference attribute="voluntaryTaxWithholdType">
														<current/>
													</reference>
											</equals>
											<equals>
												<reference attribute="caseParticipant">
													<reference attribute="evidence" />
												</reference>
												<reference attribute="caseParticipant">
													<current/>
												</reference>
											</equals>
											<equals>
												<reference attribute="related_caseParticipant">
													<reference attribute="evidence" />
												</reference>
												<reference attribute="related_caseParticipant">
													<current/>
												</reference>
											</equals>
										</members>
									</fixedlist>
								</all>
							</condition>
							<value>
								<true />
							</value>
						</when>
						<otherwise>
							<value>
								<false />
							</value>
						</otherwise>
					</choose>
				</listitemexpression>
			</dynamiclist>
		</any>
	</derivation>
</Attribute>
	<Attribute name="validateOverlapNoEndDate">
		<type>
			<javaclass name="Boolean" />
		</type>
		<derivation>
			<any>
				<dynamiclist>
					<list>
						<reference
							attribute="vtwEvidenceForClient" />
					</list>
					<listitemexpression>
						<choose>
							<type>
								<javaclass name="Boolean" />
							</type>
							<when>
								<condition>
									<all>
										<fixedlist>
											<listof>
												<javaclass name="Boolean"/>
											</listof>
											<members>
												<any>
													<fixedlist>
														<listof>
															<javaclass name="Boolean" />
														</listof>
														<members>
															<equals>
																<reference attribute="endDate">
																	<current />
																</reference>
																<null />
															</equals>
															<compare comparison="&lt;=">
																<reference attribute="startDate">
																	<reference attribute="evidence" />
																</reference>
																<reference attribute="endDate">
																	<current />
																</reference>
															</compare>
														</members>
													</fixedlist>
												</any>
												<equals>
													<reference attribute="voluntaryTaxWithholdType">
														<reference attribute="evidence" />
													</reference>
													<reference attribute="voluntaryTaxWithholdType">
														<current/>
													</reference>
												</equals>
												<equals>
													<reference attribute="caseParticipant">
														<reference attribute="evidence" />
													</reference>
													<reference attribute="caseParticipant">
														<current/>
													</reference>
												</equals>
												<equals>
													<reference attribute="related_caseParticipant">
														<reference attribute="evidence" />
													</reference>
													<reference attribute="related_caseParticipant">
														<current/>
													</reference>
											</equals>
											</members>
										</fixedlist>
									</all>
								</condition>
								<value>
									<true />
								</value>
							</when>
							<otherwise>
								<value>
									<false />
								</value>
							</otherwise>
						</choose>
					</listitemexpression>
				</dynamiclist>
			</any>
		</derivation>
	</Attribute>
	
	
	
<Attribute name="vtwEvidenceForClient">
	<type>
		<javaclass name="List">
			<ruleclass name="BDMVoluntaryTaxWithhold"
				ruleset="BDMVoluntaryTaxWithholdDataRuleSet" />
		</javaclass>
	</type>
	<derivation>
		<filter>
			<list>
				<reference attribute="vtwEvidence" />
			</list>
			<listitemexpression>
				<all>
					<fixedlist>
						<listof>
							<javaclass name="Boolean" />
						</listof>
						<members>
							<not>
								<equals>
									<reference attribute="evidenceSuccessionID" />
									<reference attribute="successionID">
										<current />
									</reference>
								</equals>
							</not>
							<equals>
								<reference attribute="participantRoleID">
									<reference attribute="related_caseParticipant">
										<reference attribute="evidence" />
									</reference>
								</reference>
								<reference attribute="participantRoleID">
									<reference attribute="related_caseParticipant">
										<current />
									</reference>
								</reference>
							</equals>
						</members>
					</fixedlist>
				</all>
			</listitemexpression>
		</filter>
	</derivation>
</Attribute>
		<!-- Amount entered should be greater than '0'  -->
		<Attribute name="validateAmountEntered">
			<type>
				<ruleclass name="Validation"
					ruleset="EvidenceValidationRuleSet" />
			</type>
			<derivation>
				<create ruleclass="Validation"
					ruleset="EvidenceValidationRuleSet">
					<not>
						<reference attribute="isvalidAmountEntered" />
					</not>
					<ResourceMessage key="ERR_INVALID_AMOUNT"
						resourceBundle="curam.bdm.pdc.rules.BDMVoluntaryTaxWithholdValidationRuleSet">
					</ResourceMessage>
				</create>
			</derivation>
		</Attribute>
		<Attribute name="isvalidAmountEntered">
			<type>
				<javaclass name="Boolean"/>
			</type>
			<derivation>
				<choose>
					<type>
						<javaclass name="Boolean"/>
					</type>
					<when>
						<condition>
							<equals>
								<reference attribute="percentageValue">
									<reference attribute="evidence" />
								</reference>
								<Number value="0" />
							</equals>
						</condition>
						<value>
							<compare comparison="&gt;">
								<reference attribute="amount">
									<reference attribute="evidence" />
								</reference>
								<Number value="0.00" />
							</compare>
						</value>
					</when>
					<otherwise>
						<value>
							<true/>
						</value>
					</otherwise>
				</choose>
			</derivation>
		</Attribute>
		
		<Attribute name="validatePercentageEntered">
			<type>
				<ruleclass name="Validation"
					ruleset="EvidenceValidationRuleSet" />
			</type>
			<derivation>
				<create ruleclass="Validation"
					ruleset="EvidenceValidationRuleSet">
					<not>
						<reference attribute="isValidPercentage" />
					</not>
					<ResourceMessage key="ERR_INVALID_PERCENTAGE"
						resourceBundle="curam.bdm.pdc.rules.BDMVoluntaryTaxWithholdValidationRuleSet">
					</ResourceMessage>
				</create>
			</derivation>
		</Attribute>
		
		<Attribute name="isValidPercentage">
			<type>
				<javaclass name="Boolean" />
			</type>
			<derivation>
				<choose>
					<type>
						<javaclass name="Boolean"/>
					</type>
					<when>
						<condition>
							<equals>
								<reference attribute="amount">
									<reference attribute="evidence" />
								</reference>
								<Number value="0" />
							</equals>
						</condition>
						<value>
							<all>
								<fixedlist>
									<listof>
										<javaclass name="Boolean" />
									</listof>
									<members>
										<not>
											<equals>
												<reference attribute="percentageValue">
													<reference attribute="evidence" />
												</reference>
												<null />
											</equals>
										</not>
										<compare comparison="&gt;">
											<reference attribute="percentageValue">
												<reference attribute="evidence" />
											</reference>
											<Number value="0" />
										</compare>
										<compare comparison="&lt;=">
											<reference attribute="percentageValue">
												<reference attribute="evidence" />
											</reference>
											<Number value="100" />
										</compare>
									</members>
								</fixedlist>
							</all>
						</value>
					</when>
					<otherwise>
						<value>
							<true/>
						</value>
					</otherwise>
				</choose>
			</derivation>
		</Attribute>
		

		<Attribute name="isQuebecResident">
			<type>
				<javaclass name="Boolean"/>
			</type>
			<derivation>
				<call class="curam.ca.gc.bdm.creole.impl.Statics" method="isValidProvinceTypeResident">
        			<type>
						<javaclass name="Boolean"/>
			        </type>
					<arguments>
				        <reference attribute="participantRoleID">
                      		 <reference attribute="related_caseParticipant">
                         		 <reference attribute="evidence"/>
							</reference>
                      	</reference>
                      	 <String value="QC"/>		
			        </arguments>
			    </call>
			</derivation>
		</Attribute>
		
		<Attribute name="validateTaxWithholdType">
			<type>
				<ruleclass name="Validation"
					ruleset="EvidenceValidationRuleSet" />
			</type>
			<derivation>
				<create ruleclass="Validation"
					ruleset="EvidenceValidationRuleSet">
				<reference attribute="isvalidTaxWithholdType" />
					<ResourceMessage key="ERR_INVALID_TAX_WITHHOLD_TYPE"
						resourceBundle="curam.bdm.pdc.rules.BDMVoluntaryTaxWithholdValidationRuleSet">
					</ResourceMessage>
				</create>
			</derivation>
		</Attribute>
		
		<Attribute name="isvalidTaxWithholdType">
			<type>
				<javaclass name="Boolean" />
			</type>
			<derivation>
				<choose>
					<type>
						<javaclass name="Boolean"/>
					</type>
					<when>
						<condition>
							<equals>
								<reference attribute="voluntaryTaxWithholdType">
										<reference attribute="evidence" />
								</reference>
								<Code table="BDMVTWType">
									<String value="BDMVTW8002" />
								</Code>
							</equals>
						</condition>
						<value>
							<choose>
								<type>
									<javaclass name="Boolean"/>
								</type>
								<when>
									<condition>
										<reference attribute="isQuebecResident"/>
									</condition>
									<value>
										<false/>
									</value>
								</when>
								<otherwise>
									<value>
										<true/>
									</value>
								</otherwise>
							</choose>
						</value>
					</when>
					<otherwise>
						<value>
							<false/>
						</value>
					</otherwise>
				</choose>
			</derivation>
		</Attribute>
		
	</Class>
</RuleSet>
