<?xml version="1.0" encoding="UTF-8"?>
<ieg-script
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="ieg-schema.xsd"
	finish-page="cw/FinishLifeEventScript.jspx"
	quit-page="cw/QuitLifeEventScript.jspx"		
	show-sections="true"
	show-progress-bar="true"
	validate-save-and-exit="false"
	config-properties="bdm-app-config"
	>

	<identifier id="BDMLifeEventPaymentUpdate" scriptversionnumber="V1" type="LifeEvent" />
	
	<!-- BEGIN Payment Change pages -->
	<section>
		<title id="ProgramInformation.Title"><![CDATA[Select program]]></title>
		<!-- BEGIN Program Selection page -->
		<question-page id="ProgramInformation" 
			progress="0" 
			read-only="false" 
			set-focus="true" 
			show-back-button="false"
			show-exit-button="true"
			show-next-button="true"
			show-person-tabs="false" 
			show-save-exit-button="false"
			entity="Person">
			<description id="MandatoryFieldsDescription"><![CDATA[<p>All fields are mandatory unless specified as optional.</br></br></p>]]></description>
			<validation expression="not(isNotNull(Person.activePrograms)) or Person.activePrograms"><message id="ProgramInformation.validation"><![CDATA[You do not have any active benefits at this time. Please click 'Delete and exit' to return to your Profile.]]></message></validation>
			<condition expression="Person.activePrograms==true">
				<cluster entity="Person">
					<list-question entity="Programs"
						id="activeProgramSelected"
						single-select="false"
						mandatory="true"
						criteria="activeProgramName!=&quot;&quot;">
						<label id="ProgramInformation.activeProgram.Label"><![CDATA[What program would you like to apply the change to?]]></label>
	              		<item-label><label-element attribute-id="activeProgramName"/></item-label>
	            	</list-question>
	            </cluster>
			</condition>
			<condition expression="Person.activePrograms==false">
				<cluster entity="Person">
					<display-text id="ProgramInformation.noActiveProgram"><![CDATA[You do not have any active benefits at this time. Please click 'Delete and exit' to return to your Profile.]]></display-text>
	            </cluster>
			</condition>
		</question-page>
	</section>
	<!-- END Program Selection page -->
		
	<section>
		<title id="Bank.PaymentInformation.Title"><![CDATA[Change Information]]></title>
		<!-- Begin Payment Information page -->
		<question-page id="PaymentInformation" 
			progress="0" 
			read-only="false" 
			set-focus="true" 
			show-back-button="true"
			show-exit-button="true"
			show-next-button="true"
			show-person-tabs="false" 
			show-save-exit-button="false"
			entity="Person">
			<description id="MandatoryFieldsDescription"><![CDATA[All fields are mandatory unless specified as optional.]]></description>
			<set-attribute id="Payment.sortCode" expression="concatenate(Payment.bankInstNum, Payment.bankBranchNum)"/>
			<set-attribute id="Payment.preferredPaymentMethod" expression="Person.preferredPaymentMethod"/>
			<validation expression="ValidateBankBranch(Payment.bankInstNum, Payment.bankBranchNum)"><message id="BankBranch.Validation"><![CDATA[Invalid combination Transit/branch number and Financial institution number.]]></message></validation>
			<validation expression="not(isNotNull(Payment.bankInstNum)) or not(isNotNull(Payment.bankBranchNum)) or not(isNotNull(Payment.accountNumber)) or validateDuplicateBankAccount(Payment.bankInstNum, Payment.bankBranchNum,Payment.accountNumber)"><message id="DuplicateBankAccount.Validation"><![CDATA[The banking details entered must be different from an existing bank account that is available to select.]]></message></validation>
			<validation expression="validateDifferentBankAccount()"><message id="DifferentBankAccount.Validation"><![CDATA[Please enter a new bank account for the program selected.]]></message></validation>
			<validation expression="validateDifferentPaymentMethod(Person.preferredPaymentMethod)"><message id="DifferentPaymentMethod.Validation"><![CDATA[Please select a new payment method.]]></message></validation>
			<cluster entity="Person">
				<display-text id="Bank.preferredPaymentMethod.Note"><![CDATA[Direct deposit is fast, convenient and secure. Register for direct deposit today to ensure you get your payments on time. Please note that the cheque will be sent to the mailing address you provided to us.]]></display-text>
				<question id="preferredPaymentMethod" mandatory="true"><label id="Bank.preferredPaymentMethod.Label"><![CDATA[How would you like to receive your payment?]]></label><layout><type>radio</type></layout></question>
			</cluster>
			<condition expression="Person.preferredPaymentMethod==&quot;EFT&quot; and Person.hasActiveBankAccounts">
				<cluster entity="Payment">
					<question id="preferredBankAccount" mandatory="true">
						<label id="Bank.preferredBankAccount.Label"><![CDATA[Would you like to add a new bank account or use an existing bank account?]]></label>
						<layout><type>radio</type></layout>
					</question>
				</cluster>
			</condition>
			<condition expression="Payment.preferredBankAccount==&quot;BDMBAC8001&quot; and Person.hasActiveBankAccounts">
				<cluster entity="Person">
					<list-question entity="PaymentBanks" id="preferredBankForProgram" single-select="true" mandatory="true" criteria="bankAccountNameAndNumber!=&quot;&quot;">
						<label id="Bank.preferredBankForProgram.Label"><![CDATA[Which bank account would you like to use?]]></label>
	              		<item-label><label-element attribute-id="bankAccountNameAndNumber"/></item-label>
	            	</list-question>
	            </cluster>
			</condition>
			<condition expression="Payment.preferredBankAccount==&quot;BDMBAC8000&quot; or (Person.preferredPaymentMethod==&quot;EFT&quot; and Person.hasActiveBankAccounts==false)">
				<cluster entity="Payment">
					<title id="Bank.BankInfo"><![CDATA[<h4>Please enter your banking details below</h4>]]></title>
					<help-text id="Bank.PaymentInfoCluster.Help"/>
					<question id="bankAccountName" mandatory="true"><label id="Bank.bankAccountName.Label"><![CDATA[Account Name]]></label></question>
					<question id="bankInstNum" mandatory="true">
						<label id="Bank.BankInstNum.Label"><![CDATA[Financial institution number (3 digits)]]></label>
						<layout><mask-format><![CDATA[{"numericOnly":"true", "blocks": [3]}]]></mask-format></layout>
					</question>
					<question id="bankBranchNum" mandatory="true">
						<label id="Bank.bankBranchNum.Label"><![CDATA[Transit/Branch Number (5 digits)]]></label>
						<layout><mask-format><![CDATA[{"numericOnly":"true", "blocks": [5]}]]></mask-format></layout>
					</question>
					<question id="accountNumber" mandatory="true">
						<label id="Bank.account.Label"><![CDATA[Account Number (7 to 12 digits)]]></label>
						<layout><mask-format><![CDATA[{"numericOnly":"true", "blocks": [12]}]]></mask-format></layout>
					</question>
					</cluster>
			</condition>
		</question-page>
		<!-- End Payment Information page -->
	</section>
	<!-- END Payment Change page -->
	
	<!-- BEGIN SUMMARY PAGE -->
	<section>
		<title id="Summary.Title"><![CDATA[Summary of changes]]></title>
		<summary-page id="SummaryPage" 
			show-back-button="true"
			entity="Person" 
			show-exit-button="true" 
			show-save-exit-button="false"
			>
			<next-button-label id="NextButton.Label"><![CDATA[Submit]]></next-button-label>
			<!-- BEGIN SUMMARY -->
			<cluster entity="Person">
				<!-- edit link only shows when having cluster title  -->
				<title id="PaymentPage.Title"><![CDATA[Payment Information]]></title>
				<edit-link start-page="PaymentInformation" />
				<list-question entity="Programs"
					id="activeProgramSelected"
					criteria="activeProgramName!=&quot;&quot;">
					<label id="ProgramInformation.activeProgram.Label"><![CDATA[What program would you like to apply the change to?]]></label>
              		<item-label><label-element attribute-id="activeProgramName"/></item-label>
            	</list-question>
            </cluster>
			<cluster entity="Person">
				<question id="preferredPaymentMethod"><label id="Bank.preferredPaymentMethod.Label"><![CDATA[How would you like to receive your payment?]]></label></question>
			</cluster>
			<condition expression="Person.preferredPaymentMethod==&quot;EFT&quot; and Person.hasActiveBankAccounts">
				<cluster entity="Payment">
					<question id="preferredBankAccount"><label id="Bank.preferredBankAccount.Label"><![CDATA[Would you like to add a new bank account or use an existing bank account?]]></label></question>
				</cluster>
			</condition>
			<condition expression="Payment.preferredBankAccount==&quot;BDMBAC8001&quot; and Person.hasActiveBankAccounts">
				<cluster entity="Person">
					<list-question entity="PaymentBanks"
						id="preferredBankForProgram"
						criteria="bankAccountNameAndNumber!=&quot;&quot;">
						<label id="Bank.preferredBankForProgram.Label"><![CDATA[Which bank account would you like to use?]]></label>
	              		<item-label><label-element attribute-id="bankAccountNameAndNumber"/></item-label>
	            	</list-question>
	            </cluster>
			</condition>
			<condition expression="Payment.preferredBankAccount==&quot;BDMBAC8000&quot; or (Person.preferredPaymentMethod==&quot;EFT&quot; and Person.hasActiveBankAccounts==false)">
				<cluster entity="Payment">
					<question id="bankAccountName"><label id="Bank.bankAccountName.Label"><![CDATA[Account Name]]></label></question>
				</cluster>
				<cluster entity="Payment">
					<layout><type>flow</type><num-rows>3</num-rows><label-alignment>right</label-alignment></layout>
					<question id="bankInstNum"><label id="Bank.BankInstNum.Label"><![CDATA[Financial institution number (3 digits)]]></label></question>
					<question id="bankBranchNum"><label id="Bank.bankBranchNum.Label"><![CDATA[Transit/branch number (5 digits)]]></label></question>
					<question id="accountNumber"><label id="Bank.account.Label"><![CDATA[Account number (7 to 12 digits)]]></label></question>
				</cluster>
			</condition>
		</summary-page>
	</section>
	<!-- END SUMMARY PAGE -->
</ieg-script>