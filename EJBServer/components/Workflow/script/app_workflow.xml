<?xml version="1.0" encoding="UTF-8"?>
<!--
  Licensed Materials - Property of IBM
  
  Copyright IBM Corporation 2012,2017. All Rights Reserved.
 
  US Government Users Restricted Rights - Use, duplication or disclosure 
  restricted by GSA ADP Schedule Contract with IBM Corp.
-->  
<!--
  
  This is the ant workflow build file for Curam projects.
  It includes tasks for copying workflow files and producing
  workflow web services.
  
-->

<project name="app_workflow" default="copyworkflowxml">
  
  <!-- Required JDE properties used in the targets. -->
  <import file="${sysenv.CURAMSDEJ}/bin/app_properties.xml" />
  <import file="${sysenv.CURAMSDEJ}/bin/app_utilities.xml" />
  
  <property name="workflow.wsschemas" value="${dir.bld.svr.workflow}/wsschemas"/>
  
  <!-- 
    Generic workflow import classpath requires a reference to the compile 
    classpath
  -->
  <path id="workflow.import.classpath">
    <path refid="lob.manager.classpath"/>
    <path refid="j.cp"/>
    <pathelement path="${dir.base.components}/Workflow/lib/Workflow.jar"/>
    <pathelement path="${dir.base.components}/Workflow/xsd"/>
  </path>
  
  <!--  ***********************************  -->
  <!--  ***  C O P Y . W O R K F L O W  ***  -->
  <!--  ***********************************  -->  
  <target name="copyworkflowxml"
    description="Copies Workflow XML files based on component order precedence">

    <!-- Copy a list of workflow process definitions from the components directory
         to the build/svr/workflow directory based on component order precedence. 
    -->    
    <mkdir dir="${dir.bld.svr.workflow}" />
        
    <property name="filesnames.file" value="${dir.bld.svr.workflow}/filesnames.txt"/>
    <delete file="${filesnames.file}"/>
    <touch file="${filesnames.file}"/>
    
    <taskdef name="orderByComponent" classname="curam.util.tools.AntOrderWorkflowByComponent" 
      classpath="${jar.tools}:${jar.coreinf}"/>
    
    <orderByComponent outputfile="${filesnames.file}">
      <fileset dir="${dir.base.components}" includes="*/workflow/*.xml"/>
    </orderByComponent>
    
    <loadfile property="workflow.file.names" srcFile="${filesnames.file}"/>
    
    <copy todir="${dir.bld.svr.workflow}" flatten="true">
      <fileset dir="${dir.base.components}" includes="${workflow.file.names}"/>
    </copy>
    
  </target>
  
  <!--  ************************************************************  -->
  <!--  ***  I M P O R T . P R O C E S S . D E F I N I T I O N S ***  -->
  <!--  ************************************************************  --> 
  <target name="importProcessDefinitions">
  
    <!-- run the lob manager to import the process definitions. -->
    
    <antcall target="dispmsg" inheritAll="false">
      <param name="prm.msg" value="Invoking Workflow Import Manager"/>
    </antcall>
    <antcall target="copyworkflowxml" inheritAll="false"/>
    
    <!-- On zOS, put in noargsconversion -->
    <condition property="java.extra.jvmargs" value="-Xnoargsconversion" >
      <os family="z/os"/>
    </condition>
    <property name="java.extra.jvmargs" value="-Dfake.property=1"/>
    <property name="disable.workflow.insertion" value="false"/>
    
    <java
      classname="curam.util.internal.workflow.impl.ProcessDefinitionImportManager"
      classpathref="workflow.import.classpath"
      fork="${java.fork}"
      failonerror="${java.failonerror}"
      maxmemory="${java.maxmemory}"
      taskname="workflowimportmanager"
      >
      <jvmarg value="${java.jvmargs}" />
      <jvmarg value="-Xms${java.maxmemory}" />
      <jvmarg value="${java.extra.jvmargs}" />
      <jvmarg value="-Dconsole.encoding=${java.console.encoding}" />
      <jvmarg value="-Dfile.encoding=UTF-8" />
      <jvmarg value="-Xbootclasspath/p:${jars.allxml}" />
      <arg value="${dir.bld.svr.workflow}" />
      <arg value="${disable.database.callback.flag}" />
    </java>
    
  </target>

  <!--  *************************************************  -->
  <!--  ***  W O R K F L O W . W E B S E R V I C E S  ***  -->
  <!--  *************************************************  --> 
  <target name="workflow.webservices" depends="copyworkflowxml">
    
    <delete dir="${workflow.wsschemas}"/>
    <mkdir dir="${workflow.wsschemas}" />
    
    <!-- On zOS, put in noargsconversion -->
    <condition property="java.extra.jvmargs" value="-Xnoargsconversion" >
      <os family="z/os"/>
    </condition>
    
    <property name="java.extra.jvmargs" value="-Dfake.property=1"/>
    <java
      classname="curam.util.internal.workflow.impl.WorkflowWebServicesGenerator"
      classpathref="workflow.import.classpath"
      fork="${java.fork}"
      failonerror="${java.failonerror}"
      maxmemory="${java.maxmemory}"
      taskname="workflow.webservices"
      >
      <sysproperty key="curam.disable.dynamic.properties" value="true"/>
      <jvmarg value="${java.jvmargs}" />
      <jvmarg value="-Xms${java.maxmemory}" />
      <jvmarg value="${java.extra.jvmargs}" />
      <jvmarg value="-Dconsole.encoding=${java.console.encoding}" />
      <jvmarg value="-Dfile.encoding=UTF-8" />
      <arg value="${dir.bld.svr.workflow}"/>
      <arg value="${workflow.wsschemas}"/>
    </java>
    
  </target>
  
  <!--  *****************  -->
  <!--  ***  THE END  ***  -->
  <!--  *****************  -->
  
</project>