<?xml version="1.0" encoding="ISO-8859-1"?>
<!--
	Licensed Materials - Property of IBM 
	
	PID 5725-H26
	
	Copyright IBM Corporation 2012,2018. All rights reserved. 
	
	US Government Users Restricted Rights - Use, duplication or disclosure
	restricted by GSA ADP Schedule Contract with IBM Corp.
-->
<project default="biapp.curamBIviewer" name="BI Client Build">

  <!--  ***************************  -->
  <!--  ***  Import Properties  ***  -->
  <!--  ***************************  -->

  <import file="./app_BIproperties.xml" />
  <import file="./app_BIUtilities.xml" />
  <import file="./app_clientbirt.xml" />
  <import file="./rep_javadoc.xml" />

  <!--  ***************************  -->
  <!--  ***  Usage              ***  -->
  <!--  ***************************  -->
  <target description="Display usage information" name="usage">
    <echo message="Use the '-projecthelp' argument to list the available targets" />
  </target>


  <!--========================
        executes a standard client build, configures the application and
        copies BIRT content.
        
        This tartet should only be used by he BI App stream
        when building a release candidate
      ========================-->
  <target depends="biapp.standardclientbuild, biapp.configureBIRTviewer.resources,biapp.initializeBIRTViewer"
          description="Builds the Curam BIRT Viewer Client and packages BI content"
          name="biapp.curamBIviewer">
  </target>


  <!--========================
          Executes a standard client build using the same mechanism
          as external users of this stream
        ========================-->
  <target depends="biapp.initdirectories"
          description="Executes a standard client build(must be used to build the BIRT Viewer)"
          name="biapp.standardclientbuild">

    <echo message="----------------------------------------------------------" />
    <echo message="start: building the Curam BIRT Viewer client application" />

    <!-- Copy all static web content.-->
    <copy failonerror="true" todir="${dir.biapp}" overwrite="false">
      <fileset dir="${dir.biapp}/components/core" includes="WebContent/**" />
    </copy>
    <!-- Copy all viewer language packs.-->
    <copy failonerror="true"
          todir="${dir.biapp.birt.languagepacks.target}"
          overwrite="true"
          verbose="true">
      <fileset dir="${dir.biapp.birt.languagepacks.source}" includes="*.jar" />
    </copy>

    <echo message="ant.build.javac.source=${ant.build.javac.source}" />
    <echo message="ant.build.javac.target=${ant.build.javac.target}" />

    <echo message="compiling source from the javasource  to ${dir.biapp.webcontent.webinf}/classes" />

    <javac srcdir="${dir.biapp}/components/core/javasource"
           destdir="${dir.biapp.webcontent.webinf}/classes"
           classpathref="compile.birt"
           debug="${compile.debug}"
           fork="${compile.fork}"
           memoryMaximumSize="${compile.maxmemory}"
           memoryInitialSize="${compile.maxmemory}"
           nowarn="${compile.nowarn}"
           optimize="${compile.optimize}"
           deprecation="${compile.deprecation}"
           verbose="${compile.verbose}"
           includeAntRuntime="${compile.includeAntRuntime}"
           includeJavaRuntime="${compile.includeJavaRuntime}"
           failonerror="false">

      <src path="${dir.biapp}/components/core/javasource" />
      <include name="**/*.java" />
    </javac>

    <delete failonerror="true" dir="${dir.biapp.bld}/manifest/cls/meta-inf" />
    <mkdir dir="${dir.biapp.bld}/manifest/cls/meta-inf" />

    <!-- zip source -->
    <manifest file="${dir.biapp.bld}/manifest/cls/meta-inf/Manifest.mf">
      <section name="common">
        <attribute name="Specification-Title" value="CuramBIRTViewer " />
        <attribute name="Specification-Vendor" value="IBM Corporation." />
      </section>
    </manifest>

    <!-- removing for CS-09765 test
    <exec osfamily="windows"
      dir="${dir.biapp.webcontent}"
      executable="attrib"
    >
      <arg line="-R /S"/>
    </exec>
    -->

    <echo message="overriding .classpath with ${dir.biapp}/scripts/.classpath" />
    <!-- web security does not work with Tomcat - ensure the token is removed -->
    <echo message="re creating .classpath file" />
    <copy force="true"
          overwrite="true"
          file="${dir.biapp}/scripts/.classpath"
          toFile="${dir.biapp}/.classpath"
          verbose="true">
      <filterset>
        <filter token="nosuchvalue01234" value=" " />
      </filterset>
    </copy>

    <echo message="re creating .project file" />
    <copy force="true"
          overwrite="true"
          file="${dir.biapp}/scripts/.project"
          toFile="${dir.biapp}/.project"
          verbose="true">
      <filterset>
        <filter token="nosuchvalue01234" value=" " />
      </filterset>
    </copy>

    <echo message="creating web.xml..." />
    <!-- ensure the curam viewer web.xml overwrites the default one -->
    <!-- the default web.xml from the CDEJ is not valid for this web application-->
    <delete file="${dir.biapp.webcontent.webinf}/web.xml"
            quiet="true"
            verbose="true" />

    <!-- web security does not work with Tomcat - ensure the token is removed -->
    <!-- set CURAM_LIST_PAGE_VALUE to true for Tomcat based debugging, value of true is case insensitive -->
    <copy overwrite="true"
          force="true"
          file="${dir.biapp.webcontent.core.webxml}"
          toFile="${dir.biapp.webcontent.webinf}/web.xml">
      <filterset>
        <filter token="WEB_SECURITY" value=" " />
        <filter token="CURAM_LIST_PAGE_VALUE" value="true" />
      </filterset>
    </copy>


    <echo message="creating ${dir.biapp.components.bicontent.scriptslib}/${biaclasses.jar}" />
    <path id="biclasses.path">
      <fileset dir="${dir.biapp.webcontent.webinf}/classes">
        <include name="**/biapp/*.class" />
      </fileset>
      <fileset dir="${dir.biapp.webcontent.webinf}/classes">
        <exclude name="curam/util/mtd/*.class" />
        <include name="curam/util/type/*.class" />
        <include name="curam/util/biapp/*.class" />
      </fileset>
    </path>

    <!-- copy to the source resources directory also - developers on the -->

    <jar manifest="${dir.biapp.bld}/manifest/cls/meta-inf/Manifest.mf"
         destfile="${dir.biapp.components.bicontent.scriptslib}/${biaclasses.jar}"
         filesonly="true"
         level="0"
         update="false">
      <path refid="biclasses.path" />
    </jar>

    <echo message="creating developerWorks jar ${dir.biapp.components.bicontent.scriptslib}${file.separator}curam-birt-mtd.jar" />
    <path id="biclasses.warm.path">
      <fileset dir="${dir.biapp.webcontent.webinf}/classes">
        <include name="curam/util/mtd/CuramWarmAppPropertyReader.class" />
        <include name="curam/util/mtd/CuramWarmBIRTConnectionFacade$1.class" />
        <include name="curam/util/mtd/CuramWarmBIRTConnectionFacade.class" />
        <include name="curam/util/mtd/CuramWarmDataSourceEventHandler.class" />

      </fileset>
    </path>


    <delete file="${dir.biapp.components.bicontent.scriptslib}${file.separator}curam-birt-mtd.jar"
            verbose="true" />

    <!-- copy to the source resources directory also - developers on the -->
    <jar manifest="${dir.biapp.bld}/manifest/cls/meta-inf/Manifest.mf"
         destfile="${dir.biapp.components.bicontent.scriptslib}${file.separator}curam-birt-mtd.jar"
         filesonly="true"
         level="0"
         basedir="${dir.biapp.webcontent.webinf}/classes"
         update="true">
    </jar>
    <echo message="end  : building the Curam BIRT Viewer client application" />
    <echo message="----------------------------------------------------------" />

  </target>

  <!--  ***************************  -->
  <!--  ***  release tasks      ***  -->
  <!--  ***************************  -->

  <target description="Completes release tasks, e.g. Java Documentation"
          name="biapp.release">
    <antcall target="biapp.javadoc">
    </antcall>
  </target>


  <target description="Generates java documentation" name="biapp.javadoc">
    <antcall target="generate.javadoc.external">
      <param name="param.javadocsoutputdir" value="${dir.biapp.doc}" />
    </antcall>
  </target>


  <!--========================
          Executes a standard BI content build using the same mechanism
          as external users of this stream
          
          This target is used by the BIContent/build.xml
        ========================-->
  <target description="Executes a BI Content client build(must be used to publish to the BIRT Viewer)"
          name="biapp.standardBIContentbuild">
    <echo message="Publishing BI Content to the Curam BIRT Viewer..." />

    <antcall target="biapp.copyBIRTcontent">

    </antcall>


  </target>

  <!--========================
        Initialize the build
      ========================-->


  <target depends="biapp.initdirectories" name="biapp.init">
  </target>

  <!--======================================================================
   cleans the BI application lib directory or unneeded jar files
   this task has not been tested so do not used until this comment
   has been updated.
      ======================================================================-->


  <target name="biapp.clean_biapp_lib"
          description="Do not use unless explicitly directed to use.">

    <echo message="Please take a back up this directory before running this command." />
    <echo message="Directory ${dir.biapp.webcontent.webinf}/lib" />


    <input message="${dir.biapp.webcontent.webinf}/lib Are you sure you want to clean your BIApp\lib (y/n)?"
           validargs="y,n"
           addproperty="do.delete" />
    <condition property="do.abort">
      <equals arg1="n" arg2="${do.delete}" />
    </condition>
    <fail if="do.abort">Build aborted by user.</fail>



    <delete quiet="false" failonerror="false" verbose="true">
      <fileset dir="${dir.biapp.webcontent.webinf}/lib"
               includes="fscontext-*.jar" />
      <fileset dir="${dir.biapp.webcontent.webinf}/lib" includes="appinf.jar" />
      <fileset dir="${dir.biapp.webcontent.webinf}/lib"
               includes="providerutil-*.jar" />
      <fileset dir="${dir.biapp.webcontent.webinf}/lib"
               includes="log4j-api-*.jar" />
      <fileset dir="${dir.biapp.webcontent.webinf}/lib"
               includes="log4j-core-*.jar" />
      <fileset dir="${dir.biapp.webcontent.webinf}/lib"
               includes="coreinf.jar" />
      <fileset dir="${dir.biapp.webcontent.webinf}/lib" includes="db2*,jar" />
      <fileset dir="${dir.biapp.webcontent.webinf}/lib" includes="h2.jar" />
      <fileset dir="${dir.biapp.webcontent.webinf}/lib" includes="ojdbc*.jar" />
      <fileset dir="${dir.biapp.webcontent.webinf}/lib"
               includes="runtime12.jar" />
      <fileset dir="${dir.biapp.webcontent.webinf}/lib" includes="sqlj.zip" />
      <fileset dir="${dir.biapp.webcontent.webinf}/lib"
               includes="translator.jar" />

    </delete>

  </target>

  <!--======================================================================
   cleans the tomcat lib directory or unneeded jar files
   this task has not been tested so do not used until this comment
   has been updated.
      ======================================================================-->


  <target name="biapp.clean_tomcat_lib"
          description="Clean Tomcat lib folder, Do not use unless explicitly directed to use.">


    <echo message="Please take a back up this directory before running this command." />
    <echo message="Directory ${dir.tomcat.lib}" />

    <input message="Are you sure you want to clean your Tomcat\lib (y/n)?"
           validargs="y,n"
           addproperty="do.delete" />
    <condition property="do.abort">
      <equals arg1="n" arg2="${do.delete}" />
    </condition>
    <fail if="do.abort">Build aborted by user.</fail>

    <input message="Enter the location of you tomcat lib directory, e.g. C:\tools\tomcat\lib?"
           addproperty="dir.tomcat.lib" />


    <delete quiet="false" failonerror="false" verbose="true">
      <fileset dir="${dir.tomcat.lib}" includes="fscontext-*.jar" />
      <fileset dir="${dir.tomcat.lib}" includes="appinf.jar" />
      <fileset dir="${dir.tomcat.lib}" includes="providerutil-*.jar" />
      <fileset dir="${dir.tomcat.lib}" includes="log4j-api-*.jar" />
      <fileset dir="${dir.tomcat.lib}" includes="log4j-core-*.jar" />
      <fileset dir="${dir.tomcat.lib}" includes="coreinf.jar" />
      <fileset dir="${dir.tomcat.lib}" includes="db2*,jar" />
      <fileset dir="${dir.tomcat.lib}" includes="h2.jar" />
      <fileset dir="${dir.tomcat.lib}" includes="ojdbc*.jar" />
      <fileset dir="${dir.tomcat.lib}" includes="runtime12.jar" />
      <fileset dir="${dir.tomcat.lib}" includes="sqlj.zip" />
      <fileset dir="${dir.tomcat.lib}" includes="translator.jar" />

    </delete>

  </target>



  <target name="biapp.configureBIRTviewer.resources">

    <echo message="--------------------------------------------------------------" />
    <echo message="start: initializing BIRT Viewer plugins - curam plugins" />

    <!--copy the oda classes to eclipse for the previewer-->
    <condition property="curam.jar.webcontent.scriptlib.do.not.overwrite"
               value="false">
      <filesmatch file1="${curam.jar.webcontent.scriptlib}"
                  file2="${curam.jar.source}" />
    </condition>
    <property name="curam.jar.webcontent.scriptlib.do.not.overwrite"
              value="true" />

    <!-- so the ODA can see the classes, warnings in Tomcat otherwise-->
    <copy force="true"
          overwrite="${curam.jar.eclipse.scriptlib.do.not.overwrite}"
          verbose="true"
          toFile="${dir.biapp.webcontent.bicontent.scriptslib}/${biaclasses.jar}"
          file="${dir.biapp.components.bicontent.scriptslib}/${biaclasses.jar}">
    </copy>
    <!-- so the ODA can see the classes, warnings in Tomcat otherwise-->
    <copy force="true"
          overwrite="${curam.jar.eclipse.scriptlib.do.not.overwrite}"
          verbose="true"
          toFile="${dir.biapp.webcontent.bicontent.scriptslib}/curam-birt-mtd.jar"
          file="${dir.biapp.components.bicontent.scriptslib}/curam-birt-mtd.jar">
    </copy>
    <!-- the classes directory will be search first the the lib for classes in this jar-->
    <condition property="biapp.webcontent.webinf.do.not.overwrite"
               value="false">
      <filesmatch file1="${dir.biapp.webcontent.webinf}/lib/${biaclasses.jar}"
                  file2="${curam.jar.source}" />
    </condition>
    <property name="biapp.webcontent.webinf.do.not.overwrite" value="true" />

    <copy force="true"
          overwrite="${biapp.webcontent.webinf.do.not.overwrite}"
          verbose="true"
          toFile="${dir.biapp.webcontent.webinf}/lib/${biaclasses.jar}"
          file="${dir.biapp.components.bicontent.scriptslib}/${biaclasses.jar}">
    </copy>
    <copy force="true"
          overwrite="${biapp.webcontent.webinf.do.not.overwrite}"
          verbose="true"
          toFile="${dir.biapp.webcontent.webinf}/lib/curam-birt-mtd.jar"
          file="${dir.biapp.components.bicontent.scriptslib}/curam-birt-mtd.jar">
    </copy>
    <echo message="end  : initializing BIRT Viewer plugins - curam plugins" />
    <echo message="--------------------------------------------------------------" />

    <echo message="--------------------------------------------------------------" />
    <echo message="start : initializing BIRT Viewer plugins - oda plugins" />


    <!-- copying to the oda drivers location as the ODA plugin
          requires these files here -->

    <copy force="true"
          failonerror="false"
          verbose="false"
          todir="${dir.biapp.webcontent.webinf.plugins}${dir.biapp.drivers.pluginslocation}">
      <path refid="RDBMSlibraries.path" />
    </copy>

    <copy force="true"
          failonerror="false"
          file="${file.DB2JCC_LICENSE_CISUZ_JAR}"
          todir="${dir.biapp.webcontent.webinf.plugins}${dir.biapp.drivers.pluginslocation}" />
    <echo message="end  : initializing BIRT Viewer plugins - oda plugins" />
    <echo message="------------------------------------------------------------" />


    <echo message="--------------------------------------------------------------" />
    <echo message="start: Publishing BIRT resources " />
    <echo message="BIRT samples..." />

    <!-- Copy birt viewer sample reports-->
    <copy overwrite="true"
          failonerror="false"
          flatten="false"
          todir="${dir.biapp.webcontent.bicontent}/sample"
          force="true">
      <fileset dir="${dir.biapp}/components/BIContent">
        <include name="birtsamples/**" />
      </fileset>
      <!-- Workaround for Ant 1.8.1 issue 49261 -->
      <filterset>
        <filter token="NoSuchTokenAnywhere123456789"
                value="NoSuchTokenAnywhere123456789" />
      </filterset>
    </copy>
    <!-- Copy birt viewer sample reports-->
    <copy force="true"
          overwrite="true"
          failonerror="false"
          flatten="false"
          todir="${dir.biapp.webcontent.bicontent}/sample">
      <fileset dir="${dir.bicontent}/components/core/birt">
        <include name="curamsamples/**/*.rptdesign" />
        <exclude name="curamsamples/**/*.rptlibrary" />
      </fileset>

      <!-- Workaround for Ant 1.8.1 issue 49261 -->
      <filterset>
        <filter token="NoSuchTokenAnywhere123456789"
                value="NoSuchTokenAnywhere123456789" />
      </filterset>
    </copy>

    <echo message="BIRT resources..." />
    <copy force="true"
          overwrite="true"
          failonerror="false"
          flatten="false"
          todir="${dir.biapp.webcontent.bicontent}">
      <fileset dir="${dir.biapp}/components/BIContent">
        <include name="resources/**" />
        <exclude name="resources/scriptlib/*.jar" />
      </fileset>
      <!-- Workaround for Ant 1.8.1 issue 49261 -->
      <filterset>
        <filter token="NoSuchTokenAnywhere123456789"
                value="NoSuchTokenAnywhere123456789" />
      </filterset>
    </copy>

    <echo message="amending styles.css..." />
    <concat fixlastline="true"
            append="false"
            destfile="${dir.biapp.webcontent}/webcontent/birt/styles/style.css"
            overwrite="true"
            forceReadOnly="true">
      <fileset file="${dir.biapp}/components/core/WebContent/webcontent/birt/styles/style.css" />
      <fileset file="${dir.biapp}/components/BIContent/resources/css/style.css" />
    </concat>
    <echo message="BIRT property files..." />
    <copy force="true"
          overwrite="true"
          failonerror="false"
          flatten="true"
          todir="${dir.biapp.webcontent.bicontent.resources.properties}"
          encoding="UTF-8"
          outputencoding="UTF-8">
      <fileset dir="${dir.biapp}/components/BIContent">
        <include name="**/*.properties" />
      </fileset>

      <!-- Workaround for Ant 1.8.1 issue 49261 -->

      <filterset>
        <filter token="NoSuchTokenAnywhere123456789"
                value="NoSuchTokenAnywhere123456789" />
      </filterset>

    </copy>
    <echo message="birt viewer sample reports..." />
    <copy force="true"
          overwrite="true"
          failonerror="false"
          flatten="false"
          todir="${dir.biapp.webcontent.bicontent}">
      <fileset dir="${dir.biapp}/components/BIContent">
        <include name="sample/**" />
      </fileset>
      <!-- Workaround for Ant 1.8.1 issue 49261 -->
      <filterset>
        <filter token="NoSuchTokenAnywhere123456789"
                value="NoSuchTokenAnywhere123456789" />
      </filterset>
    </copy>
    <echo message="end : Publishing BIRT resources " />
    <echo message="------------------------------------------------------------" />


    <echo message="Curam BIRT viewer ready for business - BI content ready" />
  </target>




  <!--===============================
        Delete all BIApp generated output
      ===============================-->
  <target description="Deletes the BIRT Viewer application" name="biapp.clean">

    <echo message="Cleaning BIRT Viewer web application at ${dir.biapp.webcontent}" />

    <!-- include when tested -->
    <delete dir="${dir.biapp.webcontent}" failonerror="true">
    </delete>

  </target>




  <!--  ******************************  -->
  <!--  ***  MAKE FILES READ_ONLY  ***  -->
  <!--  ******************************  -->
  <target name="makeReadOnly">

    <!-- removing for CS-09765 test
    <exec osfamily="windows"
      dir="${process.directory}"
      executable="attrib"
    >
      <arg line="+R /S"/>
    </exec>
    -->

  </target>
  <!--  ******************************  -->
  <!--  ***  MAKE FILES READ_ONLY  ***  -->
  <!--  ******************************  -->
  <target name="makeWrite">
    <!-- removing for CS-09765 test
    <exec osfamily="windows"
      dir="${process.directory}"
      executable="attrib"
    >
      <arg line="-R /S"/>
    </exec>
    -->

  </target>


</project>
