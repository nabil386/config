<?xml version="1.0" encoding="UTF-8"?>
<!--
	Licensed Materials - Property of IBM 
	
	PID 5725-H26
	
	Copyright IBM Corporation 2012,2018. All rights reserved. 
	
	US Government Users Restricted Rights - Use, duplication or disclosure
	restricted by GSA ADP Schedule Contract with IBM Corp.
-->
<!--
  
  This is the ant utilities file for BI project.
  It contains any configuration test tasks for the release process.
  
-->
<project name="rep_internalrelease" default="bi.internalrelease.create">

  <property environment="sysenv." />

  <condition property="CURAMBI_FILESERVER" value="${sysenv.CURAMBI_FILESERVER}">
    <isset property="sysenv.CURAMBI_FILESERVER" />
  </condition>
  <condition property="CURAMBI_FILESERVER" value="/Volumes">
    <os family="mac" />
  </condition>
  <condition property="CURAMBI_FILESERVER" value="/mnt">
    <os family="unix" />
  </condition>
  <property name="CURAMBI_FILESERVER" value="\\tiny.mul.ie.ibm.com" />

  <!--  ************************************************************  -->
  <!--  ***  copies zips to the internal release location        ***  -->
  <!--  ************************************************************  -->
  <target description="copies a zip to the internal release network location"
          name="bi.internalrelease.copyup"
          depends="checkParams">

    <echo message="About to copy ${target.version.file.name} to ${target.version.file}" />
    <tstamp>
      <format pattern="MMMdd-yyyy-hhmmss" property="time.start" />
    </tstamp>
    <tstamp>
      <format pattern="MMMdd-yyyy-hhaa" property="time.replaced" />
    </tstamp>
    <echo message="Renaming (if needed) to ${target.version.file}" />

    <!--<move file="${target.version.file}" tofile="${target.version.file}${time.replaced}" force="false" verbose="true" failonerror="false"/>-->
    <delete file="${target.version.file}" failonerror="false" quiet="true" />

    <copy file="${sysenv.BIAPP_DIR}/${target.version.file.name}"
          tofile="${target.version.file}"
          overwrite="false"
          force="true"
          verbose="true" />
    <copy file="${sysenv.BIAPP_DIR}/${target.version.file.latest.local}"
          tofile="${target.version.file.latest}"
          overwrite="false"
          force="true"
          verbose="true" />
    <copy file="${sysenv.BIAPP_DIR}/${target.version.file.appscan.name}"
          tofile="${target.version.file.appscan.nextwork}"
          overwrite="false"
          force="true"
          verbose="true" />

    <tstamp>
      <format pattern="MMddyyyy-hhmmss" property="time.end" />
    </tstamp>
    <echo message="Time taken ${time.start} - ${time.end}" />

  </target>


  <!--  ************************************************************  -->
  <!--  ***  copies zips to the internal release location        ***  -->
  <!--  ************************************************************  -->
  <target description="copies a zip to the internal release network location"
          name="bi.internalrelease.rememberbaseline"
          depends="checkParams">

    <tstamp>
      <format pattern="MMM dd yyyy hh:mm:ss" property="time.start" />
    </tstamp>
    <!-- create the release.version file for inclusion in the zip-->
    <concat forceReadOnly="true"
            append="false"
            destfile="${sysenv.REPORTING_DIR}/Baseline_${prop.label.name}.txt">Created on ${time.start} (label=baseline) ${line.separator}${prop.label.name}=${prop.label.baseline}${line.separator}</concat>
    <concat append="true"
            forceReadOnly="true"
            destfile="${CURAMBI_FILESERVER}/${bi.zip.network.location}/Baselines/Baseline_${prop.label.name}.txt">
      <fileset dir="${sysenv.REPORTING_DIR}"
               includes="Baseline_${prop.label.name}.txt" />
    </concat>

  </target>

  <!--  ************************************************************  -->
  <!--  ***  copies zips to the internal release location        ***  -->
  <!--  ************************************************************  -->
  <target description="copies a zip to the internal release network location"
          name="bi.internalrelease.create"
          depends="checkParams">

    <!-- create the release.version file for inclusion in the zip-->
    <delete file="${sysenv.BIAPP_DIR}/BIApp/CuramBIRTViewer/${bi.zip.name}Version.txt"
            quiet="false"
            verbose="true" />
    <echo file="${sysenv.BIAPP_DIR}/BIApp/CuramBIRTViewer/${bi.zip.name}Version.txt">${bi.zip.name}${bi.zip.version}</echo>
    <echo message="${sysenv.BIAPP_DIR}/${bi.zip.buildfile} -Dzipfilename=${target.version.file.name} -DcurrentDir=${sysenv.BIAPP_DIR} -Dzipfilename=${target.version.file.name} -Dnolabel=true   ${bi.zip.buildtarget}" />

    <!-- create the release-->
    <exec executable="cmd.exe"
          dir="${sysenv.BIAPP_DIR}"
          osfamily="windows"
          failonerror="true">
      <arg line="/c call" />
      <arg file="${sysenv.BIAPP_DIR}/${bi.zip.buildfile}.bat" />
      <arg value="-Dzipfilename=${target.version.file.name}" />

      <arg value="-DcurrentDir=${sysenv.BIAPP_DIR}" />
      <arg value="-Dzipfilename=${target.version.file.name}" />
      <arg value="-Dnolabel=true " />
      <arg value="${bi.zip.buildtarget}" />
    </exec>
    <exec executable="./${bi.zip.buildfile}.sh"
          dir="${sysenv.BIAPP_DIR}"
          osfamily="unix"
          failonerror="true">
      <arg value="-Dzipfilename=${target.version.file.name}" />

      <arg value="-DcurrentDir=${sysenv.BIAPP_DIR}" />
      <arg value="-Dzipfilename=${target.version.file.name}" />
      <arg value="-Dnolabel=true " />
      <arg value="${bi.zip.buildtarget}" />
    </exec>
    <copy file="${sysenv.BIAPP_DIR}/${target.version.file.name}"
          tofile="${sysenv.BIAPP_DIR}/${target.version.file.latest.local}"
          overwrite="true"
          force="true"
          verbose="true" />

    <echo>Zip ${sysenv.BIAPP_DIR}/${target.version.file.name} created.</echo>
    <copy file="${sysenv.BIAPP_DIR}/${target.version.file.name}"
          tofile="${sysenv.BIAPP_DIR}/${target.version.file.appscan.name}"
          overwrite="true"
          force="true"
          verbose="true" />

    <zip destfile="${sysenv.BIAPP_DIR}/${target.version.file.appscan.name}"
         update="true">
      <zipfileset dir="${sysenv.BIAPP_DIR}/EJBServer/tools/lib"
                  includes="javaee.jar"
                  excludes=""
                  prefix="CuramBIRTViewer/lib-ext/" />
      <zipfileset dir="${sysenv.BIAPP_DIR}/BIApp/CuramBIRTViewer/components/core/javasource"
                  includes="**/*.java"
                  excludes=""
                  prefix="CuramBIRTViewer/components/core/javasource" />
    </zip>
  </target>

  <!--  ***************************************  -->
  <!--  ***  CHECK PARAMS AND VERSION FILE  ***  -->
  <!--  ***************************************  -->
  <target name="checkParams">


    <!-- Check that the version file actually exists -->
    <available file="${version.file}" property="version.file.exists" />
    <fail message="The version file '${version.file}' can not be found."
          unless="version.file.exists" />

    <!-- Load the properties from the version file -->
    <property file="${version.file}" />

    <condition property="parameters.ok">
      <and>
        <isset property="bi.zip.name" />
        <isset property="bi.zip.version" />
        <isset property="bi.zip.network.location" />
        <isset property="bi.zip.buildtarget" />
        <isset property="bi.zip.buildfile" />
        <isset property="sysenv.CURAMBI_FILESERVER" />
      </and>
    </condition>
    <echo message="checking CURAMBI_FILESERVER=${sysenv.CURAMBI_FILESERVER}" />
    <!-- Check that the minimal amount of properties have been set -->
    <fail unless="parameters.ok">
Properties are missing from the version file ${version.file}.
The following properties must be set:
bi.zip.name=PlatformReporting
bi.zip.version=_6_0_SP2_001
bi.zip.network.location=ProductDevelopment/datawarehouse/devreleases
bi.zip.buildfile=createPlatformReportingReleaseZip.bat
bi.zip.buildtarget=createZip

    </fail>

    <property name="target.version.file.name"
              value="${bi.zip.name}${bi.zip.version}.zip" />
    <property name="target.version.file"
              value="${CURAMBI_FILESERVER}/${bi.zip.network.location}/${target.version.file.name}" />
    <property name="target.version.file.latest"
              value="${CURAMBI_FILESERVER}/${bi.zip.network.location}/${bi.zip.name}_Latest.zip" />
    <property name="target.version.file.latest.local"
              value="${bi.zip.name}_Latest.zip" />
    <property name="target.version.file.appscan.name"
              value="${bi.zip.name}${bi.zip.version}_AppScan.zip" />
    <property name="target.version.file.appscan.nextwork"
              value="${CURAMBI_FILESERVER}/${bi.zip.network.location}/${target.version.file.appscan.name}" />

    <!-- Check that the version file actually exists -->
    <available file="${CURAMBI_FILESERVER}/${bi.zip.network.location}"
               property="version.location.exists" />
    <fail message="The location  '${CURAMBI_FILESERVER}/${bi.zip.network.location}' can not be reached."
          unless="version.location.exists" />

  </target>

</project>