<?xml version="1.0" encoding="UTF-8"?>
<!--
  Licensed Materials - Property of IBM

  Copyright IBM Corporation 2012,2020. All Rights Reserved.

  US Government Users Restricted Rights - Use, duplication or disclosure
  restricted by GSA ADP Schedule Contract with IBM Corp.
-->
<project
  default="all"
  name="Generates topics as a precusor to building help"
>

  <property environment="sysenv."/>

  <property
    name="dir.bld"
    value="${sysenv.CLIENT_DIR}\build"
  />
  <property
    name="dir.business.guides"
    value="${sysenv.CLIENT_DIR}\BusinessGuides"
  />

  <!-- checks that topics.xml is already present in the Business Guides directory-->
  <target name="check.topics.xml.available">
    <condition property="topics.xml.available">
      <!-- Note that available may be deprecated, you may want to use something else-->
      <available file="${dir.business.guides}/topics.xml"/>
    </condition>
  </target>

  <!--====================
        Generates topics.
      ====================-->
  <target name="all">
      <ant target="help.create.topics"/>
      <!-- TODO: Replace overwrite functioanlity with an update function after next JDE release-->
      <ant target="help.overwrite.topics"/>
  </target>

  <!--==================
        Create topics.
      ==================-->
  <!-- This target only ever execeutes once -->
  <target name="help.create.topics"
          depends="check.topics.xml.available"
          unless="topics.xml.available">
    <ant target="extractBusinessGuideTopics"/>
    <move file="${dir.bld}/topics.xml.tmp"  tofile="${dir.business.guides}/topics.xml"/>
  </target>

  <!--====================
        Overwrite topics.
      ====================-->
  <!-- Not directly overwriting the file but backing up the
       current one first in case something should go wrong generating the new
       topic.xml file-->
  <target name="help.overwrite.topics"
          depends="check.topics.xml.available"
          if="topics.xml.available">

    <ant target="extractBusinessGuideTopics"/>

    <move file="${dir.bld}/topics.xml.tmp"  todir="${dir.business.guides}"/>

    <!-- Back up existing topcs.xml before replacing-->
    <move file="${dir.business.guides}/topics.xml" tofile="${dir.business.guides}/topics.xml_BACKUP"/>

    <!-- Make the generated topics.xml become the real one-->
    <move file="${dir.business.guides}/topics.xml.tmp" tofile="${dir.business.guides}/topics.xml"/>

    <!-- Delete backed up topics.xml-->
    <delete file="${dir.business.guides}/topics.xml_BACKUP"/>
  </target>

  <!--==============================
        Extract topics from guides.
      ==============================-->
  <target name="extractBusinessGuideTopics">
    <!-- delete the topics.xml file -->
    <delete file="${dir.bld}/topics.xml.tmp"/>
    <mkdir dir="${dir.bld}"/>
    <delete dir="${dir.bld}/guides_tmp"/>
    <mkdir dir="${dir.bld}/guides_tmp"/>

    <!-- Temporary directory where the Business Guides are copied to before
         extracting the topics-->
    <copy todir="${dir.bld}/guides_tmp">
      <fileset dir="${dir.business.guides}"/>
    </copy>

    <!-- now do a replace for the topicnames -->
    <replace dir="${dir.bld}/guides_tmp">
      <include name="**/*.xml"/>


      <replacetoken>&lt;?dbhh</replacetoken>
      <replacevalue>&lt;topic</replacevalue>
    </replace>

    <replace dir="${dir.bld}/guides_tmp">
      <include name="**/*.xml"/>
      <replacevalue>&gt; &lt;/topic&gt;</replacevalue>
      <replacetoken>?&gt;</replacetoken>
    </replace>

    <replace dir="${dir.bld}/guides_tmp">
      <include name="**/*.xml"/>
      <replacetoken>ISO-8859-1"&gt; &lt;/topic&gt;</replacetoken>
      <replacevalue>ISO-8859-1"?&gt;</replacevalue>
    </replace>

    <replace dir="${dir.bld}/guides_tmp">
      <include name="**/*.xml"/>
      <replacetoken>UTF-8"&gt; &lt;/topic&gt;</replacetoken>
      <replacevalue>UTF-8"?&gt;</replacevalue>
    </replace>


    <taskdef
      classname="curam.help.tools.anttasks.ExtractTopicInfo"
      classpath="${sysenv.CURAMCDEJ}/lib/curam/jar/helptools.jar"
      name="extractTopics"
    />

    <!-- run the extractor task -->
    <extractTopics
      file="${dir.bld}/topics.xml.tmp"
      guidesDir="${dir.bld}/guides_tmp"
      verbose="true"
    />

    <!-- remove space from Service Plans in line with application -->
    <replace file="${dir.bld}/topics.xml.tmp">
      <replacetoken>Service Plans</replacetoken>
      <replacevalue>ServicePlans</replacevalue>
    </replace>


    <delete dir="${dir.bld}/guides_tmp"/>
  </target>


</project>