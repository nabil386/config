<?xml version="1.0" encoding="UTF-8"?>
<!--
  Licensed Materials - Property of IBM

  Copyright IBM Corporation 2012,2020. All Rights Reserved.

  US Government Users Restricted Rights - Use, duplication or disclosure
  restricted by GSA ADP Schedule Contract with IBM Corp.
-->
<!--

  Script for executing SQL statements over a JDBC connection.

-->
<project name="LoadSQL" basedir="." default="load" >
  <!--  ****************************  -->
  <!--  ***  Import Properties   ***  -->
  <!--  ****************************  -->
  <property environment="env"/>
  <import file="${env.CURAMSDEJ}/bin/app_properties.xml"/>
  <import file="${env.CURAMSDEJ}/bin/app_utilities.xml"/>

  <!--Action to perform when statement fails: continue, stop, abort -->
  <property name="curam.loadsql.onerror" value="abort" />

  <target name="check.parameter.type">
    <fail
      message="The parameter -Dsql.resource must be set to either a file or directory containing SQL files."
      unless="sql.resource"
    />
    <available file="${sql.resource}" property="resource.is.directory" type="dir" />
    <available file="${sql.resource}" property="resource.is.file" type="file" />
  </target>

  <target
    depends="check.parameter.type,check.db.type,run.database.db2,run.database.ora,run.database.zos,get.decrypted.db.password"
    description="Executes SQL statements from a file/directory over a JDBC connection (use -Dsql.resource=)"
    name="load"
  >
    <antcall target="targetDirectory" inheritAll="true" />
    <antcall target="targetFile" inheritAll="true" />
  </target>

  <target name="targetDirectory" if="resource.is.directory">
    <sql
      autocommit="false"
      driver="${db.driver}"
      encoding="UTF-8"
      onerror="${curam.loadsql.onerror}"
      password="${decrypted.db.password}"
      url="${db.url}"
      userid="${curam.db.username}"
    >
      <connectionProperty
        name="sslConnection"
        value="${curam.db2.ssl}"
      />
      <connectionProperty
        name="sslTrustStoreLocation"
        value="${curam.db2.ssl.truststore.location}"
      />
      <connectionProperty
        name="sslTrustStorePassword"
        value="${curam.db2.ssl.truststore.password}"
      />
      <transaction>
        ${transaction}
      </transaction>
      <fileset dir="${sql.resource}">
        <include name="*.sql"/>
      </fileset>
      <transaction>
        COMMIT;
      </transaction>
      <classpath>
        <path refid="database.common.classpath"/>
      </classpath>
    </sql>
  </target>

  <target name="targetFile" if="resource.is.file">
    <sql
      autocommit="false"
      driver="${db.driver}"
      encoding="UTF-8"
      onerror="${curam.loadsql.onerror}"
      password="${decrypted.db.password}"
      url="${db.url}"
      userid="${curam.db.username}"
    >
      <connectionProperty
        name="sslConnection"
        value="${curam.db2.ssl}"
      />
      <connectionProperty
        name="sslTrustStoreLocation"
        value="${curam.db2.ssl.truststore.location}"
      />
      <connectionProperty
        name="sslTrustStorePassword"
        value="${curam.db2.ssl.truststore.password}"
      />
      <transaction>
        ${transaction}
      </transaction>
      <transaction src="${sql.resource}"/>
      <transaction>
        COMMIT;
      </transaction>
      <classpath>
        <path refid="database.common.classpath"/>
      </classpath>
    </sql>
  </target>
</project>