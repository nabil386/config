<?xml version="1.0" encoding="UTF-8"?>
<!--
  Licensed Materials - Property of IBM

  Copyright IBM Corporation 2012,2014. All Rights Reserved.

  US Government Users Restricted Rights - Use, duplication or disclosure
  restricted by GSA ADP Schedule Contract with IBM Corp.
-->
<!--

  This is the ant file to encrypt the password.

-->
<project name="app_encrypt" default="encrypt.password">

  <!--  ***************************  -->
  <!--  ***  Import Properties  ***  -->
  <!--  ***************************  -->
  <import file="./app_properties.xml" />

  <target name="init">
    <!-- Check to see if the password to be encrypted is set -->
    <condition property="encryption.password.valid">
        <isset property="password"/>
    </condition>
    <antcall target="check.password.valid"/>
    <!-- Check to see if the file is set -->
    <condition property="encryption.file.valid">
        <isset property="properties.file.path"/>
    </condition>
    <!-- Check to see if the password property in file is set -->
    <condition property="encryption.property.valid">
        <isset property="property"/>
    </condition>
    <!-- Check to see if either the property or file is set -->	
    <condition property="Chk.file.property">
    <or>
        <isset property="properties.file.path"/>
        <isset property="property"/>
    </or>
    </condition>
  </target>

  <!-- Fail if password property is missing. -->
  <target name="check.password.valid" unless="encryption.password.valid">
    <fail message="Missing password. Use -Dpassword to set the password. This is a mandatory property."/>
  </target>

  <!-- Fail if file name is missing. -->
  <target name="check.file.valid" unless="encryption.file.valid">
    <fail message="Missing properties file path. Use -Dproperties.file.path to set the path. This is mandatory when 'property' is set."/>
  </target>
  
  <!-- Fail if property name is missing. -->
  <target name="check.property.valid" unless="encryption.property.valid">
    <fail message="Missing property name. Use -Dproperty to set the property name. This is mandatory when 'properties.file.path' is set"/>
  </target>
  
  
  <target name="chkfile.and.prop">
    <antcall target="check.file.valid"/>
    <antcall target="check.property.valid"/>
  </target> 

  <target name="encrypt.password.options" description="Encrypts the given password" if="Chk.file.property">
    <antcall target="chkfile.and.prop"/>
    <encrypt password="${password}" propLocation="${properties.file.path}" propertyName="${property}"/>
  </target>
  
  <target name="encrypt.password.only" description="Encrypts the given password" unless="Chk.file.property">
    <encrypt password="${password}"/>
  </target>

  <target name="encrypt.password" description="Encrypts the given password" depends="init">
    <echo message="${crypto.prop.file.location}"/>
    <taskdef name="encrypt"
      classname="curam.util.tools.EncryptPassword"
      classpath="${crypto.prop.file.location}:${jar.coreinf}:${jar.tools}"/>
   <antcall target="encrypt.password.only"/>
   <antcall target="encrypt.password.options" />
  </target>
  
  
  
  <target name="digest.password" description="Creates digest of the given password" depends="init">
    <java classname="curam.util.security.EncryptionAdmin"
      classpath="${crypto.prop.file.location}:${jar.coreinf}"
      fork="${java.fork}"
      failonerror="${java.failonerror}"
      maxmemory="${java.maxmemory}"
      taskname="digest"
      >
      <jvmarg line="${java.jvmargs}" />
      <arg value="${password}"/>
      <arg value="./digest.txt"/>
    </java>
    <loadfile property="echo.digest" srcFile="./digest.txt"/>
    <delete file="./digest.txt" quiet="true" deleteonexit="true"/> 
    <echo message="Digest : ${echo.digest}"/>
    </target>

</project>
