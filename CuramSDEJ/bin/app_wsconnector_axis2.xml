<?xml version="1.0" encoding="UTF-8"?>
<!--
  Licensed Materials - Property of IBM

  Copyright IBM Corporation 2012,2018. All Rights Reserved.

  US Government Users Restricted Rights - Use, duplication or disclosure
  restricted by GSA ADP Schedule Contract with IBM Corp.
-->
<!--

  This is the ant file for Axis2 outbound webservices connectors.

-->
<project name="app_wsconnector_axis2" default="main">

  <!--  ***************************  -->
  <!--  ***  Import Properties  ***  -->
  <!--  ***************************  -->
  <import file="./app_properties.xml" />

  <import file="./app_macros.xml" />

  <import file="./app_utilities.xml" />

  <!--  **************************  -->
  <!--  ***  Common Classpath  ***  -->
  <!--  **************************  -->

  <!-- classpath referenced by generated script -->
  <path id="connector.classpath">
    <pathelement path="${sysenv.PRE_CLASSPATH}"/>
    <pathelement location="${dir.bld.svr.wsc2.jav}"/>

    <pathelement location="${jars.allxml}"/>

    <pathelement location="${jar.commonslogging}"/>
    <pathelement location="${jar.commonscodec}"/>
    <pathelement location="${jar.log4j.2.core}"/>
    <pathelement location="${jar.log4j.2.api}"/>
    <pathelement location="${jar.wsdl4j}"/>
    <pathelement location="${jar.wss4j}"/>
    <pathelement location="${jar.bcel}"/>

    <fileset dir="${dir.sde.lib}" includes="${sde.lib.axis2.list}"/>

    <path refid="jde.jars.classpath"/>

    <!-- Necessary to resolve javax.ejb.EJBObject for remote invocation -->
    <pathelement location="${jar.j2ee}"/>

    <pathelement location="${jar.mail}"/>
    <pathelement location="${jar.activation}"/>

    <!-- Necessary for remote stubs -->
    <pathelement location="${jar.implementation}"/>

    <!-- Necessary to resolve struct parameters  -->
    <pathelement location="${jar.appwebservices}"/>
    <fileset dir="${dir.base.components}" includes="*/lib/**/*_webservices.jar"/>

    <!-- Outbound web services client code   -->
    <pathelement location="${jar.axis2.wsc.proxy}"/>

    <pathelement path="${sysenv.POST_CLASSPATH}"/>
  </path>

  <!--  *************  -->
  <!--  ***  MAIN ***  -->
  <!--  *************  -->
  <target name="main"
    depends="wsconnector2.uptodate, wsconnector2.echo"
    unless="wsconnector2.notRequired">

    <antcall target="init"/>
    <antcall target="merge.config"/>

    <available file="${dir.bld.svr.wsc2}/${webservices2.config.file}"
      property="services.file.exists" />

    <antcall target="wsdl2java"/>
    <antcall target="pack.proxies2"/>

    <touch file="${dir.bld.svr.wsc2}/wsconnector2.marker"/>

  </target>


  <!--  *************************  -->
  <!--  Incremental build support  -->
  <!--  *************************  -->
  <!-- Note: If the structure of content in any ws_outbound.xml file is     -->
  <!--       changed the include below won't detect that.  An override      -->
  <!--       would be necessary to appropriately identify referenced files. -->
  <target name="wsconnector2.uptodate" unless="disable.uptodate.check">
    <uptodate property="wsconnector2.notRequired"
      targetfile="${dir.bld.svr.wsc2}/wsconnector2.marker">
      <srcfiles dir="${dir.base.components}"
        includes="*/axis/${webservices2.config.file}
                  */axis/**/*.wsdl"/>
    </uptodate>
  </target>

  <target name="wsconnector2.echo" if="wsconnector2.notRequired">
    <echo level="info" message="Skipping Axis2 outbound connector build because all files are up-to-date."/>
  </target>

  <!--  **************  -->
  <!--  ***  INIT  ***  -->
  <!--  **************  -->
  <target name="init">

    <delete dir="${dir.bld.svr.wsc2}"/>
    <mkdir dir="${dir.bld.svr.wsc2}"/>

    <mkdir dir="${dir.bld.jar}"/>

  </target>

  <!--  *******************************************  -->
  <!--  ***  M E R G E  C O N F I G  F I L E S  ***  -->
  <!--  *******************************************  -->
  <target name="merge.config">

    <!-- Merge ws_outbound.xml files -->
    <antcall target="dispmsg" inheritall="false">
      <param name="prm.msg" value="Merge ws_outbound.xml files"/>
    </antcall>

    <java
      classname="curam.util.tools.wsconnector.MergeWSOutboundWrapper"
      classpath="${jar.tools}:${jar.coreinf}:${jar.log4j.2.core}:${jar.log4j.2.api}:${jar.clover}:${jar.j2ee}"
      fork="${java.fork}"
      failonerror="${java.failonerror}"
      maxmemory="${java.maxmemory}"
      taskname="mergewsoutbound"
    >
      <jvmarg line="${java.jvmargs}" />
      <jvmarg value="-Xms${java.maxmemory}" />
      <jvmarg value="-Xbootclasspath/p:${jars.allxml}" />
      <arg line="-servercomponentorder"/>
      <arg value="${SERVER_COMPONENT_ORDER}" />
      <arg line="-serverlocalelist ${SERVER_LOCALE_LIST}" />
      <arg line="-schemalocation ${dir.sde.lib}" />
      <arg line="-mergedir ${dir.bld.svr.wsc2}" />
      <arg line="-serverdirectory ${SERVER_DIR}" />
    </java>

  </target>

  <!--  *********************  -->
  <!--  ***  WSDL 2 JAVA  ***  -->
  <!--  *********************  -->
  <target name="wsdl2java" if="services.file.exists">

    <antcall target="dispmsg" inheritall="false">
      <param name="prm.msg" value="Invoking WSDL2Java..."/>
    </antcall>

    <delete file="${dir.bld}/wsdl2java.xml" />

    <!-- Generate an ANT file: -->
    <xslt basedir="${dir.bld.svr.wsc2}"
           destdir="${dir.bld}"
           extension=".xml"
           style="${dir.sde.bin}/wsconnector2.xsl"
           in="${dir.bld.svr.wsc2}/${webservices2.config.file}"
           out="${dir.bld}/wsdl2java.xml" />

    <property name="axis2.java.outdir" value="${dir.bld.svr.wsc2.jav}"/>
    <mkdir dir="${axis2.java.outdir}"/>

    <property name="axis2.extra.wsdl2java.args" value=""/>

    <ant
      antfile="${dir.bld}/wsdl2java.xml"
      target="main"
      inheritAll="true"
      inheritRefs="true">
    </ant>

  </target>


  <!--  **********************  -->
  <!--  ***  PACK PROXIES  ***  -->
  <!--  **********************  -->
  <target name="pack.proxies2" if="services.file.exists" >
     <property name="wsproxy.include.pattern" value="**/*.class,**/*.xsb,**/*.${fil.jar.checksum}"/>
     <property name="wsproxy.exclude.pattern" value="resources/"/>

    <path id="axis2-wsc-proxy.path">
      <fileset dir="${dir.bld.svr.wsc2.jav}">
        <include name="**/*.class"/>
      </fileset>
    </path>
  	
  	<antcall target="create.class.checksum" inheritall="false">
  	  <param name="checksumbasedir" value="${dir.bld.svr.wsc2.jav}"/>
  	  <param name="checksumpath" value="axis2-wsc-proxy.path"/>
  	  <reference refid="axis2-wsc-proxy.path" />
  	</antcall>
    
    <jar destfile="${jar.axis2.wsc.proxy}" filesonly="true" level="${jar.compression}">
      <fileset dir="${dir.bld.svr.wsc2.jav}" erroronmissingdir="false" 
       includes="${wsproxy.include.pattern}" excludes="${wsproxy.exclude.pattern}"/>
    </jar>
    
  	<delete>
  	  <fileset dir="${dir.bld.svr.wsc2.jav}">
  	    <include name="**/${fil.jar.checksum}"/>
  	  </fileset>
  	</delete>

  </target>

</project>
