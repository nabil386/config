<?xml version="1.0" encoding="UTF-8"?>
<!--
  Licensed Materials - Property of IBM

  Copyright IBM Corporation 2012,2023. All Rights Reserved.

  US Government Users Restricted Rights - Use, duplication or disclosure
  restricted by GSA ADP Schedule Contract with IBM Corp.
-->
<!--
  This is the ant build file for invoking uml tools (EMX2XML converter).
-->
<project name="Uml Tools" default="main">

  <!--  ***************************  -->
  <!--  ***  Import Properties  ***  -->
  <!--  ***************************  -->
  <import file="./app_properties.xml" />

  <path id="cmp.tools.uml.classpath">
    <pathelement path="${jar.coreinf}" />
    <pathelement path="${jar.log4j.2.core}" />
    <pathelement path="${jar.log4j.2.api}" />
    <pathelement path="${jar.commons}" />
    <pathelement path="${jar.commonslang}" />
    <pathelement path="${jar.commonstext}" />
    <pathelement path="${jar.tools}" />
	<pathelement path="${jar.commons}" />
    <pathelement path="${jar.dom4j}" />
    <pathelement path="${jar.clover}" />
  </path>

  <!--  ***************************************  -->
  <!--  ***  EMX X M L C O N V E R T E R  ***  -->
  <!--  ***************************************  -->
  <target name="emx2xml">

    <antcall target="run.extractor"/>

  </target>

  <target name="xmlbuild.uptodate" unless="disable.uptodate.check">

    <!-- Used to catch Evidence Generated Curam2.xml as well as the standard Curam.xml -->
    <uptodate property="xmlbuild.notRequired" targetfile="${fil.xml.project}">
      <srcfiles dir="${SERVER_DIR}" includes="model/**/*.efx, model/**/*.emx"/>
      <srcfiles dir="${SERVER_DIR}/components" includes="*/model/**/*.efx, */model/**/*.emx"/>
    </uptodate>

  </target>

  <target name="xmlbuild.echo" if="xmlbuild.notRequired">
    <echo level="info" message="Skipping Model extraction because all files are up-to-date."/>
  </target>

  <target name="run.extractor" depends="xmlbuild.uptodate, xmlbuild.echo" unless="xmlbuild.notRequired">

    <antcall target="dispmsg" inheritall="false">
      <param name="prm.msg" value="Starting emx2xml"/>
    </antcall>

    <condition property="emx2xml.enable.tracing" value="-trace">
      <isset property="enable.tracing"/>
    </condition>
    <property name="emx2xml.enable.tracing" value="" />

    <antcall target="dispmsg" inheritall="false">
      <param name="prm.msg" value="Running Model Extraction..."/>
    </antcall>

    <path id="layeredmodels.path">
      <fileset dir="${base.dir}">
        <include name="layeredmodels/*.xml"/>
      </fileset>
    </path>
    <pathconvert pathsep=";" property="layeredmodelfiles" refid="layeredmodels.path"/>
    <available file="${base.dir}/layeredmodels" type="dir" property="reference.models" value="-r ${layeredmodelfiles}"/>
    <property name="reference.models" value="" />

    <java
      classname="curam.util.tools.emx2xml.ExtractModel"
      classpathref="cmp.tools.uml.classpath"
      fork="${java.fork}"
      failonerror="${java.failonerror}"
      maxmemory="${java.maxmemory}"
      taskname="emx2xml"
    >
      <jvmarg value="-Xbootclasspath/p:${jars.allxml}" />
      <jvmarg value="-Xms${java.maxmemory}" />
      <sysproperty key="curam.disable.dynamic.properties" value="true"/>
      <jvmarg line="${java.jvmargs}" />
      <arg value="-d" />
      <arg value="${SERVER_DIR}/components" />
      <arg value="-o" />
      <arg value="${fil.xml.project}" />
      <arg value="-m" />
      <arg value="${SERVER_MODEL_NAME}" />
      <arg line="${reference.models}" />
    </java>

    <antcall target="dispmsg" inheritall="false">
      <param name="prm.msg" value="Ending Model Extraction"/>
    </antcall>
  </target>


  <!--  *****************  -->
  <!--  ***  THE END  ***  -->
  <!--  *****************  -->

</project>
