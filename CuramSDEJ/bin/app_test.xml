<?xml version="1.0" encoding="UTF-8"?>
<!--
  Licensed Materials - Property of IBM

  Copyright IBM Corporation 2012,2014. All Rights Reserved.

  US Government Users Restricted Rights - Use, duplication or disclosure
  restricted by GSA ADP Schedule Contract with IBM Corp.
-->
<!--

  This is the ant test file for Curam projects.
  It contains a skeleton task to run junit tests

-->
<project name="app_test" default="test" xmlns:if="ant:if">

  <!--  ***************************  -->
  <!--  ***  Import Properties  ***  -->
  <!--  ***************************  -->
  <import file="./app_properties.xml" />

  <!--  **************************  -->
  <!--  ***  Import Utilities  ***  -->
  <!--  **************************  -->
  <import file="./app_utilities.xml" />

  <!--  *****************  -->
  <!--  ***  T E S T  ***  -->
  <!--  *****************  -->
  <target name="test" description="Run unit tests" depends="check.db.type">

    <antcall target="db2.activate"/>
    <parallel>
      <antcall inheritall="false" target="startXMLServer"/>
      <sequential>
        <sleep seconds="10"/>
        <antcall inheritall="true" target="_test"/>
      </sequential>
    </parallel>
    <antcall target="db2.deactivate"/>

  </target>

  <target name="_test">

    <delete dir="${dir.test.results}"/>
    <mkdir dir="${dir.test.results}"/>

    <condition property="prop.file.inside.available">
      <and>
        <isset property="curam.db.type"/>
        <isset property="curam.environment.bindings.location"/>
        <isset property="curam.db.username"/>
        <isset property="curam.db.password"/>
        <or>
          <isset property="curam.db.name"/>
          <isset property="curam.db.oracle.servicename"/>
        </or>
      </and>
    </condition>
    <antcall target="check.props.inside.file"/>

    <echo message="Running unit tests..."/>

    <!-- Use default supplement value if not set -->
    <property name="supplement" value="tests"/>
    <property name="java.extra.jvmargs" value="-Dfake.property=1"/>
    <property name="test.jvmargs" value="-Dfake.property=1"/>
    <property name="test.include.pattern" value="**/*.java"/>
    <property name="test.exclude.pattern" value=""/>
	
    <path id="test.directories">
      <dirset dir="${j.src}">
        <include name="*/${supplement}" unless="component.name"/>
        <include name="${component.name}/${supplement}" if="component.name"/>
      </dirset>
    </path>
    <pathconvert pathsep="," property="test.directories.prop" refid="test.directories"/>

    <echo if:set="component.name">Running tests for component ${component.name}</echo> 
    
    <junit
      fork="true"
      forkmode="${junit.fork.mode}"
      dir="${base.dir}"
      errorproperty="junit.error"
      failureproperty="junit.failure"
      tempdir="${dir.test.results}">
      <jvmarg line="${java.jvmargs}" />
      <jvmarg line="${test.jvmargs}" />
      <jvmarg line="${java.extra.jvmargs}" />
      <jvmarg value="-Xbootclasspath/p:${jars.allxml}" />
      <jvmarg value="-XX:PermSize=${java.minpermsize}"/>
      <jvmarg value="-XX:MaxPermSize=${java.maxpermsize}"/>
      <sysproperty key="curam.environment.bindings.location" value="${curam.environment.bindings.location}"/>
      <sysproperty key="curam.db.db2.single.connection" value="true"/>
      <sysproperty key="server.dir" value="${SERVER_DIR}"/>

      <classpath>
        <path refid="tests.cp"/>
      </classpath>
      <formatter type="brief" usefile="false"/>
      <formatter type="xml"/>
      <batchtest todir="${dir.test.results}" skipNonTests="true">
        <multirootfileset basedirs="${test.directories.prop}">
		   <include name="${test.include.pattern}" unless="include.test.file" />
           <exclude name="${test.exclude.pattern}" unless="exclude.test.file" />
           <includesfile name="${include.test.file}" if="include.test.file" />
           <excludesfile name="${exclude.test.file}" if="exclude.test.file" />
        </multirootfileset>
      </batchtest>
    </junit>

    <antcall target="test.report" inheritAll="false"/>
    <antcall inheritall="false" target="stopXMLServer"/>

    <fail message="At least one JUnit test has some errors."
      if="junit.error" unless="override.test.failures"/>
    <fail message="At least one JUnit test has some failures."
      if="junit.failure" unless="override.test.failures"/>
  </target>

  <!--  *******************************  -->
  <!--  ***  T E S T   R E P O R T  ***  -->
  <!--  *******************************  -->
  <target name="test.report" unless="notest.report">

    <junitreport>
      <fileset dir="${dir.test.results}">
        <include name="TEST-*.xml"/>
      </fileset>
      <report format="frames" todir="${dir.test.results}/html"/>
    </junitreport>

    <echo>The JUnit Test results have been created in ${dir.test.results}/html</echo>

  </target>

  <!-- ****************** -->
  <!-- *** XML SERVER *** -->
  <!-- ****************** -->
    <target
      name="startXMLServer"
      unless="dontStartXMLServer"
    >
      <echo>Calling Start XML Server</echo>
      <ant
        antfile="xmlserver.xml"
        dir="${dir.sde.xmlserver}"
      />
      <echo>Finished calling Start XML Server</echo>
    </target>


    <target
      name="stopXMLServer"
      unless="dontStartXMLServer"
    >
      <echo>Calling Stop XML Server</echo>
      <ant
        antfile="xmlserver.xml"
        dir="${dir.sde.xmlserver}"
        target="stop"
      />
      <echo>Finished calling Stop XML Server</echo>
  </target>


  <!--  ***************************  -->
  <!--  ***  DB2 . PERFORMANCE  ***  -->
  <!--  ***************************  -->
  <target name="db2.activate" if="usingdb2" unless="avoid.db2.test.performance">

    <exec executable="db2cmd" failonerror="false" osfamily="windows">
      <arg line="-c -w -i db2 activate database ${curam.db.name}"/>
    </exec>

  </target>

  <target name="db2.deactivate" if="usingdb2" unless="avoid.db2.test.performance">

    <exec executable="db2cmd" failonerror="false" osfamily="windows">
      <arg line="-c -w -i db2 deactivate database ${curam.db.name}"/>
    </exec>

  </target>

  <!--  *****************  -->
  <!--  ***  THE END  ***  -->
  <!--  *****************  -->

</project>
